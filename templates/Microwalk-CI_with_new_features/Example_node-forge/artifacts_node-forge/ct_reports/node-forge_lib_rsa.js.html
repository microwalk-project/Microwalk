<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CQR visualizer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
	<meta http-equiv="content-security-policy" content="script-src 'unsafe-inline'">
	<style>
		html, body, div, span, applet, object, iframe,
		h1, h2, h3, h4, h5, h6, p, blockquote, pre,
		a, abbr, acronym, address, big, cite, code,
		del, dfn, em, img, ins, kbd, q, s, samp,
		small, strike, strong, sub, sup, tt, var,
		b, u, i, center,
		dl, dt, dd, ol, ul, li,
		fieldset, form, label, legend,
		table, caption, tbody, tfoot, thead, tr, th, td,
		article, aside, canvas, details, embed,
		figure, figcaption, footer, header, hgroup,
		menu, nav, output, ruby, section, summary,
		time, mark, audio, video {
			margin: 0;
			padding: 0;
			border: 0;
			font-size: 100%;
			font: inherit;
			vertical-align: baseline;
		}
		/* HTML5 display-role reset for older browsers */
		article, aside, details, figcaption, figure,
		footer, header, hgroup, menu, nav, section {
			display: block;
		}
		header {
            position : static;
        }
		body {
			line-height: 1;
		}
		ol, ul {
			list-style: none;
		}
		blockquote, q {
			quotes: none;
		}
		blockquote:before, blockquote:after,
		q:before, q:after {
			content: '';
			content: none;
		}
		table {
			border-collapse: collapse;
			border-spacing: 0;
		}

		:root {
			--accent-color: #DC8ADD78;
            --height: 12px;
		}
		body {
			font-family: monospace;
		}
		header {
    		background-color: var(--accent-color);
    		color: black;
    		margin-bottom: 1em;
    		padding: 1em 3em;
    		font-size: 20px;
    	}
    	code {
    		white-space: break-spaces;
    	}

        .header-text {
            font-size: 0.6em;
        }

    	.line-number {
    		text-align: right;
    		display: inline-block;
    		min-width: 4em;
    		margin-right: 8px;
    		border-right: 4px solid var(--accent-color);
    		padding-right: 8px;
    	}
    	.line-number, code {
    		padding-top: 2px;
    		padding-bottom: 2px;
    	}
    	.issue-line .line-number {
    		background-color: #ff00008f;
    	}
    	.issue-inline-message {
    		background-color: #e8e3e8;
			margin: 5px 0;
    		padding: 1em 5em;
    		border-top: 1px solid #4E464E;
    		border-bottom: 1px solid #4E464E;
    	}
    	.issue-inline-message > details {
    		font-weight: bold;
    		margin-bottom: 1em;
    	}
    	.issue-inline-message.issue-critical > summary {
    		color: #C81E1E;
    	}
    	.issue-inline-message.issue-major > summary {
    		color: #AD5100;
    	}
    	.issue-inline-message.issue-minor > summary {
    		color: #615900;
    	}
    	p {
    		font-size: 0.em;
    		margin-top: 0.5em;
    	}
    	h1 {
    	    font-size: 2em;
            margin-bottom: 0.2em;

    	}
    	.In-the-target {
    	    font-size: 0.7em;
    	}
    	details {
            border-radius: 4px;
            padding: 0.5em 0.5em 0;
        }
        summary {
            font-weight: bold;
            margin: -0.5em -0.5em 0;
            padding: 0.5em;
        }
        details.header-issue-counter[open] {
            padding: 0.5em;
        }
        details.issue-inline-message[open] {
            background-color: #c5299e24;
            padding: 1em 5em;
            /*margin-bottom: 1em;*/
        }
        details.header-issue-counter[open] summary {
            border-bottom: 1px solid black;
            margin-bottom: 0.5em;
        }
        details.issue-inline-message[open] summary {
            /*background-color: #c5299e24;*/
    		margin-bottom: 1em;
        }
        i {
            color: black;
        }
        input[type="checkbox"] {
			accent-color: black;
		}
		button {
		    border: 0;
            line-height: 2.5;
            padding: 0 20px;
            font-size: 1rem;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
            border-radius: 10px;
            background-color: rgba(220, 0, 0, 1);
            background-image: linear-gradient(to top left, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2) 30%, rgba(0, 0, 0, 0));
            box-shadow: inset 2px 2px 3px rgba(255, 255, 255, 0.6), inset -2px -2px 3px rgba(0, 0, 0, 0.6);
		}
		.deploy-button:hover {
            background-color: rgba(255, 0, 0, 1);
        }

        .deploy-button:active {
            box-shadow: inset -2px -2px 3px rgba(255, 255, 255, 0.6), inset 2px 2px 3px rgba(0, 0, 0, 0.6);
        }

        .cstat-no {
          background: #F6C6CE;
        }
        .line-number2 {
    		text-align: right;
    		display: inline-block;
    		min-width: 4em;
    		padding-right: 8px;
            border-right: 4px solid var(--accent-color);
    	}
    	.line-number2, code {
    		padding-top: 2px;
    		padding-bottom: 2px;
    	}
    	.source-line {
        }
        .line-counter {
    		text-align: center;
    		display: inline-block;

            height: var(--height);
    		min-width: 4em;
    		margin-right: 8px;
    		border-right: 4px
    		padding-right: 8px;
    	}

        .cline-yes {
          background: rgb(230,245,208);
          padding-top: 2px;
          padding-bottom: 2px;
        }

        .cline-no {
          background: #FCE1E5;
          padding-top: 2px;
          padding-bottom: 2px;
        }

        .header-option{
          line-height: 1;
        }

        .filter-inputs {
            display: flex;
            align-items: center;
            margin-bottom: 0.5em;
        }
        
        .button-container {
            flex: 0 0 auto;
            margin-right: 20px; 
            display: flex;
            align-items: center;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
        }
        
        .severity-options, .issue-type-options {
            margin-top: 1px;
        }

    </style>
  </head>
  <body>
  <div class="grid-container">
    <div class="head">
    <header>
<h1>node-forge/lib/rsa.js</h1>
        <div class="filter-inputs">
            <div class="button-container">
                <button onclick="change()" title="Click here to expand or collapse all leak details!" class="deploy-button" Id="button1"> Deploy leak details </button>
            </div>
            <div class="options-container">
                <div class="severity-options">
                    <span class="header-option">Severity:</span>
                    <label><input type="checkbox" name="severity-critical" > Critical</label>
                    <label><input type="checkbox" name="severity-major" > Major</label>
                    <label><input type="checkbox" name="severity-minor" > Minor</label>
                </div>
                <div class="issue-type-options">
                    <span>Issue type:</span>
                    <label><input type="checkbox" name="issue-type-memory-access" > Memory access</label>
                    <label><input type="checkbox" name="issue-type-branch" > Branch</label>
                </div>
            </div>
        </div>
        <p class="header-text">Total number of problem found: 4 out of 180</p>
        <p class="header-text">Number of critical in file: 2   ≅ 50%</p>
        <p class="header-text">Number of memory access error in file: 3   ≅ 75%</p>
        <p class="header-text">Coverage proportion (on the number of character): 30252 / 58109   ≅ 52%</p>
        <p class="header-text">Coverage proportion (on the number of line): 1028 / 1949   ≅ 53%</p><details open class="header-issue-counter"><summary class="In-the-target"><name="target-RSASIGN" Id="RSASIGN" <h2>In the target-RSASIGN</h2></summary>
            <p class="header-text">Number of problem found: 4</p>
            <p class="header-text">Number of critical: 2   ≅ 50%</p>
            <p class="header-text">Number of memory access error: 3   ≅ 75%</p></details>
    </header>
    </div><div class="source-line"><span class="line-number ">1</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">2</span><span class="line-counter cline-yes">&nbsp</span><code> * Javascript implementation of basic RSA algorithms.</code></div>
<div class="source-line"><span class="line-number ">3</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">4</span><span class="line-counter cline-yes">&nbsp</span><code> * @author Dave Longley</code></div>
<div class="source-line"><span class="line-number ">5</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">6</span><span class="line-counter cline-yes">&nbsp</span><code> * Copyright (c) 2010-2014 Digital Bazaar, Inc.</code></div>
<div class="source-line"><span class="line-number ">7</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">8</span><span class="line-counter cline-yes">&nbsp</span><code> * The only algorithm currently supported for PKI is RSA.</code></div>
<div class="source-line"><span class="line-number ">9</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">10</span><span class="line-counter cline-yes">&nbsp</span><code> * An RSA key is often stored in ASN.1 DER format. The SubjectPublicKeyInfo</code></div>
<div class="source-line"><span class="line-number ">11</span><span class="line-counter cline-yes">&nbsp</span><code> * ASN.1 structure is composed of an algorithm of type AlgorithmIdentifier</code></div>
<div class="source-line"><span class="line-number ">12</span><span class="line-counter cline-yes">&nbsp</span><code> * and a subjectPublicKey of type bit string.</code></div>
<div class="source-line"><span class="line-number ">13</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">14</span><span class="line-counter cline-yes">&nbsp</span><code> * The AlgorithmIdentifier contains an Object Identifier (OID) and parameters</code></div>
<div class="source-line"><span class="line-number ">15</span><span class="line-counter cline-yes">&nbsp</span><code> * for the algorithm, if any. In the case of RSA, there aren&#39;t any.</code></div>
<div class="source-line"><span class="line-number ">16</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">17</span><span class="line-counter cline-yes">&nbsp</span><code> * SubjectPublicKeyInfo ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">18</span><span class="line-counter cline-yes">&nbsp</span><code> *   algorithm AlgorithmIdentifier,</code></div>
<div class="source-line"><span class="line-number ">19</span><span class="line-counter cline-yes">&nbsp</span><code> *   subjectPublicKey BIT STRING</code></div>
<div class="source-line"><span class="line-number ">20</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">21</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">22</span><span class="line-counter cline-yes">&nbsp</span><code> * AlgorithmIdentifer ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">23</span><span class="line-counter cline-yes">&nbsp</span><code> *   algorithm OBJECT IDENTIFIER,</code></div>
<div class="source-line"><span class="line-number ">24</span><span class="line-counter cline-yes">&nbsp</span><code> *   parameters ANY DEFINED BY algorithm OPTIONAL</code></div>
<div class="source-line"><span class="line-number ">25</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">26</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">27</span><span class="line-counter cline-yes">&nbsp</span><code> * For an RSA public key, the subjectPublicKey is:</code></div>
<div class="source-line"><span class="line-number ">28</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">29</span><span class="line-counter cline-yes">&nbsp</span><code> * RSAPublicKey ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">30</span><span class="line-counter cline-yes">&nbsp</span><code> *   modulus            INTEGER,    -- n</code></div>
<div class="source-line"><span class="line-number ">31</span><span class="line-counter cline-yes">&nbsp</span><code> *   publicExponent     INTEGER     -- e</code></div>
<div class="source-line"><span class="line-number ">32</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">33</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">34</span><span class="line-counter cline-yes">&nbsp</span><code> * PrivateKeyInfo ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">35</span><span class="line-counter cline-yes">&nbsp</span><code> *   version                   Version,</code></div>
<div class="source-line"><span class="line-number ">36</span><span class="line-counter cline-yes">&nbsp</span><code> *   privateKeyAlgorithm       PrivateKeyAlgorithmIdentifier,</code></div>
<div class="source-line"><span class="line-number ">37</span><span class="line-counter cline-yes">&nbsp</span><code> *   privateKey                PrivateKey,</code></div>
<div class="source-line"><span class="line-number ">38</span><span class="line-counter cline-yes">&nbsp</span><code> *   attributes           [0]  IMPLICIT Attributes OPTIONAL</code></div>
<div class="source-line"><span class="line-number ">39</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">40</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">41</span><span class="line-counter cline-yes">&nbsp</span><code> * Version ::= INTEGER</code></div>
<div class="source-line"><span class="line-number ">42</span><span class="line-counter cline-yes">&nbsp</span><code> * PrivateKeyAlgorithmIdentifier ::= AlgorithmIdentifier</code></div>
<div class="source-line"><span class="line-number ">43</span><span class="line-counter cline-yes">&nbsp</span><code> * PrivateKey ::= OCTET STRING</code></div>
<div class="source-line"><span class="line-number ">44</span><span class="line-counter cline-yes">&nbsp</span><code> * Attributes ::= SET OF Attribute</code></div>
<div class="source-line"><span class="line-number ">45</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">46</span><span class="line-counter cline-yes">&nbsp</span><code> * An RSA private key as the following structure:</code></div>
<div class="source-line"><span class="line-number ">47</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">48</span><span class="line-counter cline-yes">&nbsp</span><code> * RSAPrivateKey ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">49</span><span class="line-counter cline-yes">&nbsp</span><code> *   version Version,</code></div>
<div class="source-line"><span class="line-number ">50</span><span class="line-counter cline-yes">&nbsp</span><code> *   modulus INTEGER, -- n</code></div>
<div class="source-line"><span class="line-number ">51</span><span class="line-counter cline-yes">&nbsp</span><code> *   publicExponent INTEGER, -- e</code></div>
<div class="source-line"><span class="line-number ">52</span><span class="line-counter cline-yes">&nbsp</span><code> *   privateExponent INTEGER, -- d</code></div>
<div class="source-line"><span class="line-number ">53</span><span class="line-counter cline-yes">&nbsp</span><code> *   prime1 INTEGER, -- p</code></div>
<div class="source-line"><span class="line-number ">54</span><span class="line-counter cline-yes">&nbsp</span><code> *   prime2 INTEGER, -- q</code></div>
<div class="source-line"><span class="line-number ">55</span><span class="line-counter cline-yes">&nbsp</span><code> *   exponent1 INTEGER, -- d mod (p-1)</code></div>
<div class="source-line"><span class="line-number ">56</span><span class="line-counter cline-yes">&nbsp</span><code> *   exponent2 INTEGER, -- d mod (q-1)</code></div>
<div class="source-line"><span class="line-number ">57</span><span class="line-counter cline-yes">&nbsp</span><code> *   coefficient INTEGER -- (inverse of q) mod p</code></div>
<div class="source-line"><span class="line-number ">58</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">59</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">60</span><span class="line-counter cline-yes">&nbsp</span><code> * Version ::= INTEGER</code></div>
<div class="source-line"><span class="line-number ">61</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">62</span><span class="line-counter cline-yes">&nbsp</span><code> * The OID for the RSA key algorithm is: 1.2.840.113549.1.1.1</code></div>
<div class="source-line"><span class="line-number ">63</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">64</span><span class="line-counter cline-yes">&nbsp</span><code>var forge = require(&#39;./forge&#39;);</code></div>
<div class="source-line"><span class="line-number ">65</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./asn1&#39;);</code></div>
<div class="source-line"><span class="line-number ">66</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./jsbn&#39;);</code></div>
<div class="source-line"><span class="line-number ">67</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./oids&#39;);</code></div>
<div class="source-line"><span class="line-number ">68</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./pkcs1&#39;);</code></div>
<div class="source-line"><span class="line-number ">69</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./prime&#39;);</code></div>
<div class="source-line"><span class="line-number ">70</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./random&#39;);</code></div>
<div class="source-line"><span class="line-number ">71</span><span class="line-counter cline-yes">&nbsp</span><code>require(&#39;./util&#39;);</code></div>
<div class="source-line"><span class="line-number ">72</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">73</span><span class="line-counter cline-yes">&nbsp</span><code>if(typeof BigInteger === &#39;undefined&#39;) {</code></div>
<div class="source-line"><span class="line-number ">74</span><span class="line-counter cline-yes">&nbsp</span><code>  var BigInteger = forge.jsbn.BigInteger;</code></div>
<div class="source-line"><span class="line-number ">75</span><span class="line-counter cline-yes">&nbsp</span><code>}</code></div>
<div class="source-line"><span class="line-number ">76</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">77</span><span class="line-counter cline-no">！</span><code><span>var _crypto = forge.util.isNodejs ? require(&#39;crypto&#39;) </span><span class="cstat-no" title="statement not covered">: null</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">78</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">79</span><span class="line-counter cline-yes">&nbsp</span><code>// shortcut for asn.1 API</code></div>
<div class="source-line"><span class="line-number ">80</span><span class="line-counter cline-yes">&nbsp</span><code>var asn1 = forge.asn1;</code></div>
<div class="source-line"><span class="line-number ">81</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">82</span><span class="line-counter cline-yes">&nbsp</span><code>// shortcut for util API</code></div>
<div class="source-line"><span class="line-number ">83</span><span class="line-counter cline-yes">&nbsp</span><code>var util = forge.util;</code></div>
<div class="source-line"><span class="line-number ">84</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">85</span><span class="line-counter cline-yes">&nbsp</span><code>/*</code></div>
<div class="source-line"><span class="line-number ">86</span><span class="line-counter cline-yes">&nbsp</span><code> * RSA encryption and decryption, see RFC 2313.</code></div>
<div class="source-line"><span class="line-number ">87</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">88</span><span class="line-counter cline-no">！</span><code><span>forge.pki = forge.pki </span><span class="cstat-no" title="statement not covered">|| {}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">89</span><span class="line-counter cline-yes">&nbsp</span><code>module.exports = forge.pki.rsa = forge.rsa = forge.rsa || {};</code></div>
<div class="source-line"><span class="line-number ">90</span><span class="line-counter cline-yes">&nbsp</span><code>var pki = forge.pki;</code></div>
<div class="source-line"><span class="line-number ">91</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">92</span><span class="line-counter cline-yes">&nbsp</span><code>// for finding primes, which are 30k+i for i = 1, 7, 11, 13, 17, 19, 23, 29</code></div>
<div class="source-line"><span class="line-number ">93</span><span class="line-counter cline-yes">&nbsp</span><code>var GCD_30_DELTA = [6, 4, 2, 4, 2, 4, 6, 2];</code></div>
<div class="source-line"><span class="line-number ">94</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">95</span><span class="line-counter cline-yes">&nbsp</span><code>// validator for a PrivateKeyInfo structure</code></div>
<div class="source-line"><span class="line-number ">96</span><span class="line-counter cline-yes">&nbsp</span><code>var privateKeyValidator = {</code></div>
<div class="source-line"><span class="line-number ">97</span><span class="line-counter cline-yes">&nbsp</span><code>  // PrivateKeyInfo</code></div>
<div class="source-line"><span class="line-number ">98</span><span class="line-counter cline-yes">&nbsp</span><code>  name: &#39;PrivateKeyInfo&#39;,</code></div>
<div class="source-line"><span class="line-number ">99</span><span class="line-counter cline-yes">&nbsp</span><code>  tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">100</span><span class="line-counter cline-yes">&nbsp</span><code>  type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">101</span><span class="line-counter cline-yes">&nbsp</span><code>  constructed: true,</code></div>
<div class="source-line"><span class="line-number ">102</span><span class="line-counter cline-yes">&nbsp</span><code>  value: [{</code></div>
<div class="source-line"><span class="line-number ">103</span><span class="line-counter cline-yes">&nbsp</span><code>    // Version (INTEGER)</code></div>
<div class="source-line"><span class="line-number ">104</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;PrivateKeyInfo.version&#39;,</code></div>
<div class="source-line"><span class="line-number ">105</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">106</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">107</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">108</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyVersion&#39;</code></div>
<div class="source-line"><span class="line-number ">109</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">110</span><span class="line-counter cline-yes">&nbsp</span><code>    // privateKeyAlgorithm</code></div>
<div class="source-line"><span class="line-number ">111</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;PrivateKeyInfo.privateKeyAlgorithm&#39;,</code></div>
<div class="source-line"><span class="line-number ">112</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">113</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">114</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: true,</code></div>
<div class="source-line"><span class="line-number ">115</span><span class="line-counter cline-yes">&nbsp</span><code>    value: [{</code></div>
<div class="source-line"><span class="line-number ">116</span><span class="line-counter cline-yes">&nbsp</span><code>      name: &#39;AlgorithmIdentifier.algorithm&#39;,</code></div>
<div class="source-line"><span class="line-number ">117</span><span class="line-counter cline-yes">&nbsp</span><code>      tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">118</span><span class="line-counter cline-yes">&nbsp</span><code>      type: asn1.Type.OID,</code></div>
<div class="source-line"><span class="line-number ">119</span><span class="line-counter cline-yes">&nbsp</span><code>      constructed: false,</code></div>
<div class="source-line"><span class="line-number ">120</span><span class="line-counter cline-yes">&nbsp</span><code>      capture: &#39;privateKeyOid&#39;</code></div>
<div class="source-line"><span class="line-number ">121</span><span class="line-counter cline-yes">&nbsp</span><code>    }]</code></div>
<div class="source-line"><span class="line-number ">122</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">123</span><span class="line-counter cline-yes">&nbsp</span><code>    // PrivateKey</code></div>
<div class="source-line"><span class="line-number ">124</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;PrivateKeyInfo&#39;,</code></div>
<div class="source-line"><span class="line-number ">125</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">126</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.OCTETSTRING,</code></div>
<div class="source-line"><span class="line-number ">127</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">128</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKey&#39;</code></div>
<div class="source-line"><span class="line-number ">129</span><span class="line-counter cline-yes">&nbsp</span><code>  }]</code></div>
<div class="source-line"><span class="line-number ">130</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">131</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">132</span><span class="line-counter cline-yes">&nbsp</span><code>// validator for an RSA private key</code></div>
<div class="source-line"><span class="line-number ">133</span><span class="line-counter cline-yes">&nbsp</span><code>var rsaPrivateKeyValidator = {</code></div>
<div class="source-line"><span class="line-number ">134</span><span class="line-counter cline-yes">&nbsp</span><code>  // RSAPrivateKey</code></div>
<div class="source-line"><span class="line-number ">135</span><span class="line-counter cline-yes">&nbsp</span><code>  name: &#39;RSAPrivateKey&#39;,</code></div>
<div class="source-line"><span class="line-number ">136</span><span class="line-counter cline-yes">&nbsp</span><code>  tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">137</span><span class="line-counter cline-yes">&nbsp</span><code>  type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">138</span><span class="line-counter cline-yes">&nbsp</span><code>  constructed: true,</code></div>
<div class="source-line"><span class="line-number ">139</span><span class="line-counter cline-yes">&nbsp</span><code>  value: [{</code></div>
<div class="source-line"><span class="line-number ">140</span><span class="line-counter cline-yes">&nbsp</span><code>    // Version (INTEGER)</code></div>
<div class="source-line"><span class="line-number ">141</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.version&#39;,</code></div>
<div class="source-line"><span class="line-number ">142</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">143</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">144</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">145</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyVersion&#39;</code></div>
<div class="source-line"><span class="line-number ">146</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">147</span><span class="line-counter cline-yes">&nbsp</span><code>    // modulus (n)</code></div>
<div class="source-line"><span class="line-number ">148</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.modulus&#39;,</code></div>
<div class="source-line"><span class="line-number ">149</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">150</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">151</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">152</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyModulus&#39;</code></div>
<div class="source-line"><span class="line-number ">153</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">154</span><span class="line-counter cline-yes">&nbsp</span><code>    // publicExponent (e)</code></div>
<div class="source-line"><span class="line-number ">155</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.publicExponent&#39;,</code></div>
<div class="source-line"><span class="line-number ">156</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">157</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">158</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">159</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyPublicExponent&#39;</code></div>
<div class="source-line"><span class="line-number ">160</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">161</span><span class="line-counter cline-yes">&nbsp</span><code>    // privateExponent (d)</code></div>
<div class="source-line"><span class="line-number ">162</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.privateExponent&#39;,</code></div>
<div class="source-line"><span class="line-number ">163</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">164</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">165</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">166</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyPrivateExponent&#39;</code></div>
<div class="source-line"><span class="line-number ">167</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">168</span><span class="line-counter cline-yes">&nbsp</span><code>    // prime1 (p)</code></div>
<div class="source-line"><span class="line-number ">169</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.prime1&#39;,</code></div>
<div class="source-line"><span class="line-number ">170</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">171</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">172</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">173</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyPrime1&#39;</code></div>
<div class="source-line"><span class="line-number ">174</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">175</span><span class="line-counter cline-yes">&nbsp</span><code>    // prime2 (q)</code></div>
<div class="source-line"><span class="line-number ">176</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.prime2&#39;,</code></div>
<div class="source-line"><span class="line-number ">177</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">178</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">179</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">180</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyPrime2&#39;</code></div>
<div class="source-line"><span class="line-number ">181</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">182</span><span class="line-counter cline-yes">&nbsp</span><code>    // exponent1 (d mod (p-1))</code></div>
<div class="source-line"><span class="line-number ">183</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.exponent1&#39;,</code></div>
<div class="source-line"><span class="line-number ">184</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">185</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">186</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">187</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyExponent1&#39;</code></div>
<div class="source-line"><span class="line-number ">188</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">189</span><span class="line-counter cline-yes">&nbsp</span><code>    // exponent2 (d mod (q-1))</code></div>
<div class="source-line"><span class="line-number ">190</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.exponent2&#39;,</code></div>
<div class="source-line"><span class="line-number ">191</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">192</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">193</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">194</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyExponent2&#39;</code></div>
<div class="source-line"><span class="line-number ">195</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">196</span><span class="line-counter cline-yes">&nbsp</span><code>    // coefficient ((inverse of q) mod p)</code></div>
<div class="source-line"><span class="line-number ">197</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPrivateKey.coefficient&#39;,</code></div>
<div class="source-line"><span class="line-number ">198</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">199</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">200</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">201</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;privateKeyCoefficient&#39;</code></div>
<div class="source-line"><span class="line-number ">202</span><span class="line-counter cline-yes">&nbsp</span><code>  }]</code></div>
<div class="source-line"><span class="line-number ">203</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">204</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">205</span><span class="line-counter cline-yes">&nbsp</span><code>// validator for an RSA public key</code></div>
<div class="source-line"><span class="line-number ">206</span><span class="line-counter cline-yes">&nbsp</span><code>var rsaPublicKeyValidator = {</code></div>
<div class="source-line"><span class="line-number ">207</span><span class="line-counter cline-yes">&nbsp</span><code>  // RSAPublicKey</code></div>
<div class="source-line"><span class="line-number ">208</span><span class="line-counter cline-yes">&nbsp</span><code>  name: &#39;RSAPublicKey&#39;,</code></div>
<div class="source-line"><span class="line-number ">209</span><span class="line-counter cline-yes">&nbsp</span><code>  tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">210</span><span class="line-counter cline-yes">&nbsp</span><code>  type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">211</span><span class="line-counter cline-yes">&nbsp</span><code>  constructed: true,</code></div>
<div class="source-line"><span class="line-number ">212</span><span class="line-counter cline-yes">&nbsp</span><code>  value: [{</code></div>
<div class="source-line"><span class="line-number ">213</span><span class="line-counter cline-yes">&nbsp</span><code>    // modulus (n)</code></div>
<div class="source-line"><span class="line-number ">214</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPublicKey.modulus&#39;,</code></div>
<div class="source-line"><span class="line-number ">215</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">216</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">217</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">218</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;publicKeyModulus&#39;</code></div>
<div class="source-line"><span class="line-number ">219</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">220</span><span class="line-counter cline-yes">&nbsp</span><code>    // publicExponent (e)</code></div>
<div class="source-line"><span class="line-number ">221</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;RSAPublicKey.exponent&#39;,</code></div>
<div class="source-line"><span class="line-number ">222</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">223</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.INTEGER,</code></div>
<div class="source-line"><span class="line-number ">224</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">225</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;publicKeyExponent&#39;</code></div>
<div class="source-line"><span class="line-number ">226</span><span class="line-counter cline-yes">&nbsp</span><code>  }]</code></div>
<div class="source-line"><span class="line-number ">227</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">228</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">229</span><span class="line-counter cline-yes">&nbsp</span><code>// validator for an SubjectPublicKeyInfo structure</code></div>
<div class="source-line"><span class="line-number ">230</span><span class="line-counter cline-yes">&nbsp</span><code>// Note: Currently only works with an RSA public key</code></div>
<div class="source-line"><span class="line-number ">231</span><span class="line-counter cline-yes">&nbsp</span><code>var publicKeyValidator = forge.pki.rsa.publicKeyValidator = {</code></div>
<div class="source-line"><span class="line-number ">232</span><span class="line-counter cline-yes">&nbsp</span><code>  name: &#39;SubjectPublicKeyInfo&#39;,</code></div>
<div class="source-line"><span class="line-number ">233</span><span class="line-counter cline-yes">&nbsp</span><code>  tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">234</span><span class="line-counter cline-yes">&nbsp</span><code>  type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">235</span><span class="line-counter cline-yes">&nbsp</span><code>  constructed: true,</code></div>
<div class="source-line"><span class="line-number ">236</span><span class="line-counter cline-yes">&nbsp</span><code>  captureAsn1: &#39;subjectPublicKeyInfo&#39;,</code></div>
<div class="source-line"><span class="line-number ">237</span><span class="line-counter cline-yes">&nbsp</span><code>  value: [{</code></div>
<div class="source-line"><span class="line-number ">238</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;SubjectPublicKeyInfo.AlgorithmIdentifier&#39;,</code></div>
<div class="source-line"><span class="line-number ">239</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">240</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">241</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: true,</code></div>
<div class="source-line"><span class="line-number ">242</span><span class="line-counter cline-yes">&nbsp</span><code>    value: [{</code></div>
<div class="source-line"><span class="line-number ">243</span><span class="line-counter cline-yes">&nbsp</span><code>      name: &#39;AlgorithmIdentifier.algorithm&#39;,</code></div>
<div class="source-line"><span class="line-number ">244</span><span class="line-counter cline-yes">&nbsp</span><code>      tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">245</span><span class="line-counter cline-yes">&nbsp</span><code>      type: asn1.Type.OID,</code></div>
<div class="source-line"><span class="line-number ">246</span><span class="line-counter cline-yes">&nbsp</span><code>      constructed: false,</code></div>
<div class="source-line"><span class="line-number ">247</span><span class="line-counter cline-yes">&nbsp</span><code>      capture: &#39;publicKeyOid&#39;</code></div>
<div class="source-line"><span class="line-number ">248</span><span class="line-counter cline-yes">&nbsp</span><code>    }]</code></div>
<div class="source-line"><span class="line-number ">249</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">250</span><span class="line-counter cline-yes">&nbsp</span><code>    // subjectPublicKey</code></div>
<div class="source-line"><span class="line-number ">251</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;SubjectPublicKeyInfo.subjectPublicKey&#39;,</code></div>
<div class="source-line"><span class="line-number ">252</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">253</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.BITSTRING,</code></div>
<div class="source-line"><span class="line-number ">254</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">255</span><span class="line-counter cline-yes">&nbsp</span><code>    value: [{</code></div>
<div class="source-line"><span class="line-number ">256</span><span class="line-counter cline-yes">&nbsp</span><code>      // RSAPublicKey</code></div>
<div class="source-line"><span class="line-number ">257</span><span class="line-counter cline-yes">&nbsp</span><code>      name: &#39;SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey&#39;,</code></div>
<div class="source-line"><span class="line-number ">258</span><span class="line-counter cline-yes">&nbsp</span><code>      tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">259</span><span class="line-counter cline-yes">&nbsp</span><code>      type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">260</span><span class="line-counter cline-yes">&nbsp</span><code>      constructed: true,</code></div>
<div class="source-line"><span class="line-number ">261</span><span class="line-counter cline-yes">&nbsp</span><code>      optional: true,</code></div>
<div class="source-line"><span class="line-number ">262</span><span class="line-counter cline-yes">&nbsp</span><code>      captureAsn1: &#39;rsaPublicKey&#39;</code></div>
<div class="source-line"><span class="line-number ">263</span><span class="line-counter cline-yes">&nbsp</span><code>    }]</code></div>
<div class="source-line"><span class="line-number ">264</span><span class="line-counter cline-yes">&nbsp</span><code>  }]</code></div>
<div class="source-line"><span class="line-number ">265</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">266</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">267</span><span class="line-counter cline-yes">&nbsp</span><code>// validator for a DigestInfo structure</code></div>
<div class="source-line"><span class="line-number ">268</span><span class="line-counter cline-yes">&nbsp</span><code>var digestInfoValidator = {</code></div>
<div class="source-line"><span class="line-number ">269</span><span class="line-counter cline-yes">&nbsp</span><code>  name: &#39;DigestInfo&#39;,</code></div>
<div class="source-line"><span class="line-number ">270</span><span class="line-counter cline-yes">&nbsp</span><code>  tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">271</span><span class="line-counter cline-yes">&nbsp</span><code>  type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">272</span><span class="line-counter cline-yes">&nbsp</span><code>  constructed: true,</code></div>
<div class="source-line"><span class="line-number ">273</span><span class="line-counter cline-yes">&nbsp</span><code>  value: [{</code></div>
<div class="source-line"><span class="line-number ">274</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;DigestInfo.DigestAlgorithm&#39;,</code></div>
<div class="source-line"><span class="line-number ">275</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">276</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.SEQUENCE,</code></div>
<div class="source-line"><span class="line-number ">277</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: true,</code></div>
<div class="source-line"><span class="line-number ">278</span><span class="line-counter cline-yes">&nbsp</span><code>    value: [{</code></div>
<div class="source-line"><span class="line-number ">279</span><span class="line-counter cline-yes">&nbsp</span><code>      name: &#39;DigestInfo.DigestAlgorithm.algorithmIdentifier&#39;,</code></div>
<div class="source-line"><span class="line-number ">280</span><span class="line-counter cline-yes">&nbsp</span><code>      tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">281</span><span class="line-counter cline-yes">&nbsp</span><code>      type: asn1.Type.OID,</code></div>
<div class="source-line"><span class="line-number ">282</span><span class="line-counter cline-yes">&nbsp</span><code>      constructed: false,</code></div>
<div class="source-line"><span class="line-number ">283</span><span class="line-counter cline-yes">&nbsp</span><code>      capture: &#39;algorithmIdentifier&#39;</code></div>
<div class="source-line"><span class="line-number ">284</span><span class="line-counter cline-yes">&nbsp</span><code>    }, {</code></div>
<div class="source-line"><span class="line-number ">285</span><span class="line-counter cline-yes">&nbsp</span><code>      // NULL paramters</code></div>
<div class="source-line"><span class="line-number ">286</span><span class="line-counter cline-yes">&nbsp</span><code>      name: &#39;DigestInfo.DigestAlgorithm.parameters&#39;,</code></div>
<div class="source-line"><span class="line-number ">287</span><span class="line-counter cline-yes">&nbsp</span><code>      tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">288</span><span class="line-counter cline-yes">&nbsp</span><code>      type: asn1.Type.NULL,</code></div>
<div class="source-line"><span class="line-number ">289</span><span class="line-counter cline-yes">&nbsp</span><code>      // captured only to check existence for md2 and md5</code></div>
<div class="source-line"><span class="line-number ">290</span><span class="line-counter cline-yes">&nbsp</span><code>      capture: &#39;parameters&#39;,</code></div>
<div class="source-line"><span class="line-number ">291</span><span class="line-counter cline-yes">&nbsp</span><code>      optional: true,</code></div>
<div class="source-line"><span class="line-number ">292</span><span class="line-counter cline-yes">&nbsp</span><code>      constructed: false</code></div>
<div class="source-line"><span class="line-number ">293</span><span class="line-counter cline-yes">&nbsp</span><code>    }]</code></div>
<div class="source-line"><span class="line-number ">294</span><span class="line-counter cline-yes">&nbsp</span><code>  }, {</code></div>
<div class="source-line"><span class="line-number ">295</span><span class="line-counter cline-yes">&nbsp</span><code>    // digest</code></div>
<div class="source-line"><span class="line-number ">296</span><span class="line-counter cline-yes">&nbsp</span><code>    name: &#39;DigestInfo.digest&#39;,</code></div>
<div class="source-line"><span class="line-number ">297</span><span class="line-counter cline-yes">&nbsp</span><code>    tagClass: asn1.Class.UNIVERSAL,</code></div>
<div class="source-line"><span class="line-number ">298</span><span class="line-counter cline-yes">&nbsp</span><code>    type: asn1.Type.OCTETSTRING,</code></div>
<div class="source-line"><span class="line-number ">299</span><span class="line-counter cline-yes">&nbsp</span><code>    constructed: false,</code></div>
<div class="source-line"><span class="line-number ">300</span><span class="line-counter cline-yes">&nbsp</span><code>    capture: &#39;digest&#39;</code></div>
<div class="source-line"><span class="line-number ">301</span><span class="line-counter cline-yes">&nbsp</span><code>  }]</code></div>
<div class="source-line"><span class="line-number ">302</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">303</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">304</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">305</span><span class="line-counter cline-yes">&nbsp</span><code> * Wrap digest in DigestInfo object.</code></div>
<div class="source-line"><span class="line-number ">306</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">307</span><span class="line-counter cline-yes">&nbsp</span><code> * This function implements EMSA-PKCS1-v1_5-ENCODE as per RFC 3447.</code></div>
<div class="source-line"><span class="line-number ">308</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">309</span><span class="line-counter cline-yes">&nbsp</span><code> * DigestInfo ::= SEQUENCE {</code></div>
<div class="source-line"><span class="line-number ">310</span><span class="line-counter cline-yes">&nbsp</span><code> *   digestAlgorithm DigestAlgorithmIdentifier,</code></div>
<div class="source-line"><span class="line-number ">311</span><span class="line-counter cline-yes">&nbsp</span><code> *   digest Digest</code></div>
<div class="source-line"><span class="line-number ">312</span><span class="line-counter cline-yes">&nbsp</span><code> * }</code></div>
<div class="source-line"><span class="line-number ">313</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">314</span><span class="line-counter cline-yes">&nbsp</span><code> * DigestAlgorithmIdentifier ::= AlgorithmIdentifier</code></div>
<div class="source-line"><span class="line-number ">315</span><span class="line-counter cline-yes">&nbsp</span><code> * Digest ::= OCTET STRING</code></div>
<div class="source-line"><span class="line-number ">316</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">317</span><span class="line-counter cline-yes">&nbsp</span><code> * @param md the message digest object with the hash to sign.</code></div>
<div class="source-line"><span class="line-number ">318</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">319</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the encoded message (ready for RSA encrytion)</code></div>
<div class="source-line"><span class="line-number ">320</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">321</span><span class="line-counter cline-yes">&nbsp</span><code>var emsaPkcs1v15encode = function(md) {</code></div>
<div class="source-line"><span class="line-number ">322</span><span class="line-counter cline-yes">&nbsp</span><code>  // get the oid for the algorithm</code></div>
<div class="source-line"><span class="line-number ">323</span><span class="line-counter cline-yes">&nbsp</span><code>  var oid;</code></div>
<div class="source-line"><span class="line-number ">324</span><span class="line-counter cline-yes">&nbsp</span><code>  if(md.algorithm in pki.oids) {</code></div>
<div class="source-line"><span class="line-number ">325</span><span class="line-counter cline-yes">&nbsp</span><code>    oid = pki.oids[md.algorithm];</code></div>
<div class="source-line"><span class="line-number ">326</span><span class="line-counter cline-no">！</span><code><span>  }</span><span class="cstat-no" title="statement not covered"> else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">327</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var error = new Error(&#39;Unknown message digest algorithm.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">328</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.algorithm = md.algorithm;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">329</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">330</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">331</span><span class="line-counter cline-yes">&nbsp</span><code>  var oidBytes = asn1.oidToDer(oid).getBytes();</code></div>
<div class="source-line"><span class="line-number ">332</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">333</span><span class="line-counter cline-yes">&nbsp</span><code>  // create the digest info</code></div>
<div class="source-line"><span class="line-number ">334</span><span class="line-counter cline-yes">&nbsp</span><code>  var digestInfo = asn1.create(</code></div>
<div class="source-line"><span class="line-number ">335</span><span class="line-counter cline-yes">&nbsp</span><code>    asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, []);</code></div>
<div class="source-line"><span class="line-number ">336</span><span class="line-counter cline-yes">&nbsp</span><code>  var digestAlgorithm = asn1.create(</code></div>
<div class="source-line"><span class="line-number ">337</span><span class="line-counter cline-yes">&nbsp</span><code>    asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, []);</code></div>
<div class="source-line"><span class="line-number ">338</span><span class="line-counter cline-yes">&nbsp</span><code>  digestAlgorithm.value.push(asn1.create(</code></div>
<div class="source-line"><span class="line-number ">339</span><span class="line-counter cline-yes">&nbsp</span><code>    asn1.Class.UNIVERSAL, asn1.Type.OID, false, oidBytes));</code></div>
<div class="source-line"><span class="line-number ">340</span><span class="line-counter cline-yes">&nbsp</span><code>  digestAlgorithm.value.push(asn1.create(</code></div>
<div class="source-line"><span class="line-number ">341</span><span class="line-counter cline-yes">&nbsp</span><code>    asn1.Class.UNIVERSAL, asn1.Type.NULL, false, &#39;&#39;));</code></div>
<div class="source-line"><span class="line-number ">342</span><span class="line-counter cline-yes">&nbsp</span><code>  var digest = asn1.create(</code></div>
<div class="source-line"><span class="line-number ">343</span><span class="line-counter cline-yes">&nbsp</span><code>    asn1.Class.UNIVERSAL, asn1.Type.OCTETSTRING,</code></div>
<div class="source-line"><span class="line-number ">344</span><span class="line-counter cline-yes">&nbsp</span><code>    false, md.digest().getBytes());</code></div>
<div class="source-line"><span class="line-number ">345</span><span class="line-counter cline-yes">&nbsp</span><code>  digestInfo.value.push(digestAlgorithm);</code></div>
<div class="source-line"><span class="line-number ">346</span><span class="line-counter cline-yes">&nbsp</span><code>  digestInfo.value.push(digest);</code></div>
<div class="source-line"><span class="line-number ">347</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">348</span><span class="line-counter cline-yes">&nbsp</span><code>  // encode digest info</code></div>
<div class="source-line"><span class="line-number ">349</span><span class="line-counter cline-yes">&nbsp</span><code>  return asn1.toDer(digestInfo).getBytes();</code></div>
<div class="source-line"><span class="line-number ">350</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">351</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">352</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">353</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs x^c mod n (RSA encryption or decryption operation).</code></div>
<div class="source-line"><span class="line-number ">354</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">355</span><span class="line-counter cline-yes">&nbsp</span><code> * @param x the number to raise and mod.</code></div>
<div class="source-line"><span class="line-number ">356</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the key to use.</code></div>
<div class="source-line"><span class="line-number ">357</span><span class="line-counter cline-yes">&nbsp</span><code> * @param pub true if the key is public, false if private.</code></div>
<div class="source-line"><span class="line-number ">358</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">359</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the result of x^c mod n.</code></div>
<div class="source-line"><span class="line-number ">360</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">361</span><span class="line-counter cline-yes">&nbsp</span><code>var _modPow = function(x, key, pub) {</code></div>
<div class="source-line"><span class="line-number ">362</span><span class="line-counter cline-no">！</span><code><span>  if(pub) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">363</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return x.modPow(key.e, key.n);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">364</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">365</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">366</span><span class="line-counter cline-no">！</span><code><span>  if(!key.p || !key.q) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">367</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // allow calculation without CRT params (slow)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">368</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return x.modPow(key.d, key.n);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">369</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">370</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">371</span><span class="line-counter cline-yes">&nbsp</span><code>  // pre-compute dP, dQ, and qInv if necessary</code></div>
<div class="source-line"><span class="line-number ">372</span><span class="line-counter cline-no">！</span><code><span>  if(!key.dP) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">373</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    key.dP = key.d.mod(key.p.subtract(BigInteger.ONE));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">374</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">375</span><span class="line-counter cline-no">！</span><code><span>  if(!key.dQ) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">376</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    key.dQ = key.d.mod(key.q.subtract(BigInteger.ONE));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">377</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">378</span><span class="line-counter cline-no">！</span><code><span>  if(!key.qInv) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">379</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    key.qInv = key.q.modInverse(key.p);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">380</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">381</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">382</span><span class="line-counter cline-yes">&nbsp</span><code>  /* Chinese remainder theorem (CRT) states:</code></div>
<div class="source-line"><span class="line-number ">383</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">384</span><span class="line-counter cline-yes">&nbsp</span><code>    Suppose n1, n2, ..., nk are positive integers which are pairwise</code></div>
<div class="source-line"><span class="line-number ">385</span><span class="line-counter cline-yes">&nbsp</span><code>    coprime (n1 and n2 have no common factors other than 1). For any</code></div>
<div class="source-line"><span class="line-number ">386</span><span class="line-counter cline-yes">&nbsp</span><code>    integers x1, x2, ..., xk there exists an integer x solving the</code></div>
<div class="source-line"><span class="line-number ">387</span><span class="line-counter cline-yes">&nbsp</span><code>    system of simultaneous congruences (where ~= means modularly</code></div>
<div class="source-line"><span class="line-number ">388</span><span class="line-counter cline-yes">&nbsp</span><code>    congruent so a ~= b mod n means a mod n = b mod n):</code></div>
<div class="source-line"><span class="line-number ">389</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">390</span><span class="line-counter cline-yes">&nbsp</span><code>    x ~= x1 mod n1</code></div>
<div class="source-line"><span class="line-number ">391</span><span class="line-counter cline-yes">&nbsp</span><code>    x ~= x2 mod n2</code></div>
<div class="source-line"><span class="line-number ">392</span><span class="line-counter cline-yes">&nbsp</span><code>    ...</code></div>
<div class="source-line"><span class="line-number ">393</span><span class="line-counter cline-yes">&nbsp</span><code>    x ~= xk mod nk</code></div>
<div class="source-line"><span class="line-number ">394</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">395</span><span class="line-counter cline-yes">&nbsp</span><code>    This system of congruences has a single simultaneous solution x</code></div>
<div class="source-line"><span class="line-number ">396</span><span class="line-counter cline-yes">&nbsp</span><code>    between 0 and n - 1. Furthermore, each xk solution and x itself</code></div>
<div class="source-line"><span class="line-number ">397</span><span class="line-counter cline-yes">&nbsp</span><code>    is congruent modulo the product n = n1*n2*...*nk.</code></div>
<div class="source-line"><span class="line-number ">398</span><span class="line-counter cline-yes">&nbsp</span><code>    So x1 mod n = x2 mod n = xk mod n = x mod n.</code></div>
<div class="source-line"><span class="line-number ">399</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">400</span><span class="line-counter cline-yes">&nbsp</span><code>    The single simultaneous solution x can be solved with the following</code></div>
<div class="source-line"><span class="line-number ">401</span><span class="line-counter cline-yes">&nbsp</span><code>    equation:</code></div>
<div class="source-line"><span class="line-number ">402</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">403</span><span class="line-counter cline-yes">&nbsp</span><code>    x = sum(xi*ri*si) mod n where ri = n/ni and si = ri^-1 mod ni.</code></div>
<div class="source-line"><span class="line-number ">404</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">405</span><span class="line-counter cline-yes">&nbsp</span><code>    Where x is less than n, xi = x mod ni.</code></div>
<div class="source-line"><span class="line-number ">406</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">407</span><span class="line-counter cline-yes">&nbsp</span><code>    For RSA we are only concerned with k = 2. The modulus n = pq, where</code></div>
<div class="source-line"><span class="line-number ">408</span><span class="line-counter cline-yes">&nbsp</span><code>    p and q are coprime. The RSA decryption algorithm is:</code></div>
<div class="source-line"><span class="line-number ">409</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">410</span><span class="line-counter cline-yes">&nbsp</span><code>    y = x^d mod n</code></div>
<div class="source-line"><span class="line-number ">411</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">412</span><span class="line-counter cline-yes">&nbsp</span><code>    Given the above:</code></div>
<div class="source-line"><span class="line-number ">413</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">414</span><span class="line-counter cline-yes">&nbsp</span><code>    x1 = x^d mod p</code></div>
<div class="source-line"><span class="line-number ">415</span><span class="line-counter cline-yes">&nbsp</span><code>    r1 = n/p = q</code></div>
<div class="source-line"><span class="line-number ">416</span><span class="line-counter cline-yes">&nbsp</span><code>    s1 = q^-1 mod p</code></div>
<div class="source-line"><span class="line-number ">417</span><span class="line-counter cline-yes">&nbsp</span><code>    x2 = x^d mod q</code></div>
<div class="source-line"><span class="line-number ">418</span><span class="line-counter cline-yes">&nbsp</span><code>    r2 = n/q = p</code></div>
<div class="source-line"><span class="line-number ">419</span><span class="line-counter cline-yes">&nbsp</span><code>    s2 = p^-1 mod q</code></div>
<div class="source-line"><span class="line-number ">420</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">421</span><span class="line-counter cline-yes">&nbsp</span><code>    So y = (x1r1s1 + x2r2s2) mod n</code></div>
<div class="source-line"><span class="line-number ">422</span><span class="line-counter cline-yes">&nbsp</span><code>         = ((x^d mod p)q(q^-1 mod p) + (x^d mod q)p(p^-1 mod q)) mod n</code></div>
<div class="source-line"><span class="line-number ">423</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">424</span><span class="line-counter cline-yes">&nbsp</span><code>    According to Fermat&#39;s Little Theorem, if the modulus P is prime,</code></div>
<div class="source-line"><span class="line-number ">425</span><span class="line-counter cline-yes">&nbsp</span><code>    for any integer A not evenly divisible by P, A^(P-1) ~= 1 mod P.</code></div>
<div class="source-line"><span class="line-number ">426</span><span class="line-counter cline-yes">&nbsp</span><code>    Since A is not divisible by P it follows that if:</code></div>
<div class="source-line"><span class="line-number ">427</span><span class="line-counter cline-yes">&nbsp</span><code>    N ~= M mod (P - 1), then A^N mod P = A^M mod P. Therefore:</code></div>
<div class="source-line"><span class="line-number ">428</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">429</span><span class="line-counter cline-yes">&nbsp</span><code>    A^N mod P = A^(M mod (P - 1)) mod P. (The latter takes less effort</code></div>
<div class="source-line"><span class="line-number ">430</span><span class="line-counter cline-yes">&nbsp</span><code>    to calculate). In order to calculate x^d mod p more quickly the</code></div>
<div class="source-line"><span class="line-number ">431</span><span class="line-counter cline-yes">&nbsp</span><code>    exponent d mod (p - 1) is stored in the RSA private key (the same</code></div>
<div class="source-line"><span class="line-number ">432</span><span class="line-counter cline-yes">&nbsp</span><code>    is done for x^d mod q). These values are referred to as dP and dQ</code></div>
<div class="source-line"><span class="line-number ">433</span><span class="line-counter cline-yes">&nbsp</span><code>    respectively. Therefore we now have:</code></div>
<div class="source-line"><span class="line-number ">434</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">435</span><span class="line-counter cline-yes">&nbsp</span><code>    y = ((x^dP mod p)q(q^-1 mod p) + (x^dQ mod q)p(p^-1 mod q)) mod n</code></div>
<div class="source-line"><span class="line-number ">436</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">437</span><span class="line-counter cline-yes">&nbsp</span><code>    Since we&#39;ll be reducing x^dP by modulo p (same for q) we can also</code></div>
<div class="source-line"><span class="line-number ">438</span><span class="line-counter cline-yes">&nbsp</span><code>    reduce x by p (and q respectively) before hand. Therefore, let</code></div>
<div class="source-line"><span class="line-number ">439</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">440</span><span class="line-counter cline-yes">&nbsp</span><code>    xp = ((x mod p)^dP mod p), and</code></div>
<div class="source-line"><span class="line-number ">441</span><span class="line-counter cline-yes">&nbsp</span><code>    xq = ((x mod q)^dQ mod q), yielding:</code></div>
<div class="source-line"><span class="line-number ">442</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">443</span><span class="line-counter cline-yes">&nbsp</span><code>    y = (xp*q*(q^-1 mod p) + xq*p*(p^-1 mod q)) mod n</code></div>
<div class="source-line"><span class="line-number ">444</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">445</span><span class="line-counter cline-yes">&nbsp</span><code>    This can be further reduced to a simple algorithm that only</code></div>
<div class="source-line"><span class="line-number ">446</span><span class="line-counter cline-yes">&nbsp</span><code>    requires 1 inverse (the q inverse is used) to be used and stored.</code></div>
<div class="source-line"><span class="line-number ">447</span><span class="line-counter cline-yes">&nbsp</span><code>    The algorithm is called Garner&#39;s algorithm. If qInv is the</code></div>
<div class="source-line"><span class="line-number ">448</span><span class="line-counter cline-yes">&nbsp</span><code>    inverse of q, we simply calculate:</code></div>
<div class="source-line"><span class="line-number ">449</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">450</span><span class="line-counter cline-yes">&nbsp</span><code>    y = (qInv*(xp - xq) mod p) * q + xq</code></div>
<div class="source-line"><span class="line-number ">451</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">452</span><span class="line-counter cline-yes">&nbsp</span><code>    However, there are two further complications. First, we need to</code></div>
<div class="source-line"><span class="line-number ">453</span><span class="line-counter cline-yes">&nbsp</span><code>    ensure that xp &gt; xq to prevent signed BigIntegers from being used</code></div>
<div class="source-line"><span class="line-number ">454</span><span class="line-counter cline-yes">&nbsp</span><code>    so we add p until this is true (since we will be mod&#39;ing with</code></div>
<div class="source-line"><span class="line-number ">455</span><span class="line-counter cline-yes">&nbsp</span><code>    p anyway). Then, there is a known timing attack on algorithms</code></div>
<div class="source-line"><span class="line-number ">456</span><span class="line-counter cline-yes">&nbsp</span><code>    using the CRT. To mitigate this risk, &quot;cryptographic blinding&quot;</code></div>
<div class="source-line"><span class="line-number ">457</span><span class="line-counter cline-yes">&nbsp</span><code>    should be used. This requires simply generating a random number r</code></div>
<div class="source-line"><span class="line-number ">458</span><span class="line-counter cline-yes">&nbsp</span><code>    between 0 and n-1 and its inverse and multiplying x by r^e before</code></div>
<div class="source-line"><span class="line-number ">459</span><span class="line-counter cline-yes">&nbsp</span><code>    calculating y and then multiplying y by r^-1 afterwards. Note that</code></div>
<div class="source-line"><span class="line-number ">460</span><span class="line-counter cline-yes">&nbsp</span><code>    r must be coprime with n (gcd(r, n) === 1) in order to have an</code></div>
<div class="source-line"><span class="line-number ">461</span><span class="line-counter cline-yes">&nbsp</span><code>    inverse.</code></div>
<div class="source-line"><span class="line-number ">462</span><span class="line-counter cline-yes">&nbsp</span><code>  */</code></div>
<div class="source-line"><span class="line-number ">463</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">464</span><span class="line-counter cline-yes">&nbsp</span><code>  // cryptographic blinding</code></div>
<div class="source-line"><span class="line-number ">465</span><span class="line-counter cline-yes">&nbsp</span><code>  var r;</code></div>
<div class="source-line"><span class="line-number ">466</span><span class="line-counter cline-yes">&nbsp</span><code>  do {</code></div>
<div class="source-line"><span class="line-number ">467</span><span class="line-counter cline-yes">&nbsp</span><code>    r = new BigInteger(</code></div>
<div class="source-line"><span class="line-number ">468</span><span class="line-counter cline-yes">&nbsp</span><code>      forge.util.bytesToHex(forge.random.getBytes(key.n.bitLength() / 8)),</code></div>
<div class="source-line"><span class="line-number ">469</span><span class="line-counter cline-yes">&nbsp</span><code>      16);</code></div>
<div class="source-line"><span class="line-number ">470</span><span class="line-counter cline-yes">&nbsp</span><code>  } while(r.compareTo(key.n) &gt;= 0 || !r.gcd(key.n).equals(BigInteger.ONE));</code></div>
<div class="source-line"><span class="line-number ">471</span><span class="line-counter cline-yes">&nbsp</span><code>  x = x.multiply(r.modPow(key.e, key.n)).mod(key.n);</code></div>
<div class="source-line"><span class="line-number ">472</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">473</span><span class="line-counter cline-yes">&nbsp</span><code>  // calculate xp and xq</code></div>
<div class="source-line"><span class="line-number ">474</span><span class="line-counter cline-yes">&nbsp</span><code>  var xp = x.mod(key.p).modPow(key.dP, key.p);</code></div>
<div class="source-line"><span class="line-number ">475</span><span class="line-counter cline-yes">&nbsp</span><code>  var xq = x.mod(key.q).modPow(key.dQ, key.q);</code></div>
<div class="source-line"><span class="line-number ">476</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">477</span><span class="line-counter cline-yes">&nbsp</span><code>  // xp must be larger than xq to avoid signed bit usage</code></div>
<mark class="issue-line"><div class="source-line"><span class="line-number ">478</span><span class="line-counter cline-yes">&nbsp</span><code>  while(xp.compareTo(xq) &lt; 0) {</code></div>
</mark><details class="issue-inline-message issue-major issue-branch target-RSASIGN">
                        <summary>🚨&nbsp;<i>RSASIGN</i> Secret-dependent branch</summary>
                <div class="issue-description">[RSASIGN] Found vulnerable jump instruction, leakage score 80.00% +/- 20%.</div>
            </details><mark class="issue-line"><div class="source-line"><span class="line-number ">479</span><span class="line-counter cline-yes">&nbsp</span><code>    xp = xp.add(key.p);</code></div>
</mark><details class="issue-inline-message issue-critical issue-memory-access target-RSASIGN">
                        <summary>💥&nbsp;<i>RSASIGN</i> Secret-dependent memory access</summary>
                <div class="issue-description">[RSASIGN] Found vulnerable memory access instruction, leakage score 100.00% +/- 0%.</div>
            </details><div class="source-line"><span class="line-number ">480</span><span class="line-counter cline-yes">&nbsp</span><code>  }</code></div>
<div class="source-line"><span class="line-number ">481</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">482</span><span class="line-counter cline-yes">&nbsp</span><code>  // do last step</code></div>
<mark class="issue-line"><div class="source-line"><span class="line-number ">483</span><span class="line-counter cline-yes">&nbsp</span><code>  var y = xp.subtract(xq)</code></div>
</mark><details class="issue-inline-message issue-critical issue-memory-access target-RSASIGN">
                        <summary>💥&nbsp;<i>RSASIGN</i> Secret-dependent memory access</summary>
                <div class="issue-description">[RSASIGN] Found vulnerable memory access instruction, leakage score 100.00% +/- 0%.</div>
            </details><div class="source-line"><span class="line-number ">484</span><span class="line-counter cline-yes">&nbsp</span><code>    .multiply(key.qInv).mod(key.p)</code></div>
<div class="source-line"><span class="line-number ">485</span><span class="line-counter cline-yes">&nbsp</span><code>    .multiply(key.q).add(xq);</code></div>
<div class="source-line"><span class="line-number ">486</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">487</span><span class="line-counter cline-yes">&nbsp</span><code>  // remove effect of random for cryptographic blinding</code></div>
<div class="source-line"><span class="line-number ">488</span><span class="line-counter cline-yes">&nbsp</span><code>  y = y.multiply(r.modInverse(key.n)).mod(key.n);</code></div>
<div class="source-line"><span class="line-number ">489</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">490</span><span class="line-counter cline-yes">&nbsp</span><code>  return y;</code></div>
<div class="source-line"><span class="line-number ">491</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">492</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">493</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">494</span><span class="line-counter cline-yes">&nbsp</span><code> * NOTE: THIS METHOD IS DEPRECATED, use &#39;sign&#39; on a private key object or</code></div>
<div class="source-line"><span class="line-number ">495</span><span class="line-counter cline-yes">&nbsp</span><code> * &#39;encrypt&#39; on a public key object instead.</code></div>
<div class="source-line"><span class="line-number ">496</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">497</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs RSA encryption.</code></div>
<div class="source-line"><span class="line-number ">498</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">499</span><span class="line-counter cline-yes">&nbsp</span><code> * The parameter bt controls whether to put padding bytes before the</code></div>
<div class="source-line"><span class="line-number ">500</span><span class="line-counter cline-yes">&nbsp</span><code> * message passed in. Set bt to either true or false to disable padding</code></div>
<div class="source-line"><span class="line-number ">501</span><span class="line-counter cline-yes">&nbsp</span><code> * completely (in order to handle e.g. EMSA-PSS encoding seperately before),</code></div>
<div class="source-line"><span class="line-number ">502</span><span class="line-counter cline-yes">&nbsp</span><code> * signaling whether the encryption operation is a public key operation</code></div>
<div class="source-line"><span class="line-number ">503</span><span class="line-counter cline-yes">&nbsp</span><code> * (i.e. encrypting data) or not, i.e. private key operation (data signing).</code></div>
<div class="source-line"><span class="line-number ">504</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">505</span><span class="line-counter cline-yes">&nbsp</span><code> * For PKCS#1 v1.5 padding pass in the block type to use, i.e. either 0x01</code></div>
<div class="source-line"><span class="line-number ">506</span><span class="line-counter cline-yes">&nbsp</span><code> * (for signing) or 0x02 (for encryption). The key operation mode (private</code></div>
<div class="source-line"><span class="line-number ">507</span><span class="line-counter cline-yes">&nbsp</span><code> * or public) is derived from this flag in that case).</code></div>
<div class="source-line"><span class="line-number ">508</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">509</span><span class="line-counter cline-yes">&nbsp</span><code> * @param m the message to encrypt as a byte string.</code></div>
<div class="source-line"><span class="line-number ">510</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the RSA key to use.</code></div>
<div class="source-line"><span class="line-number ">511</span><span class="line-counter cline-yes">&nbsp</span><code> * @param bt for PKCS#1 v1.5 padding, the block type to use</code></div>
<div class="source-line"><span class="line-number ">512</span><span class="line-counter cline-yes">&nbsp</span><code> *   (0x01 for private key, 0x02 for public),</code></div>
<div class="source-line"><span class="line-number ">513</span><span class="line-counter cline-yes">&nbsp</span><code> *   to disable padding: true = public key, false = private key.</code></div>
<div class="source-line"><span class="line-number ">514</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">515</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the encrypted bytes as a string.</code></div>
<div class="source-line"><span class="line-number ">516</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">517</span><span class="line-counter cline-yes">&nbsp</span><code>pki.rsa.encrypt = function(m, key, bt) {</code></div>
<div class="source-line"><span class="line-number ">518</span><span class="line-counter cline-yes">&nbsp</span><code>  var pub = bt;</code></div>
<div class="source-line"><span class="line-number ">519</span><span class="line-counter cline-yes">&nbsp</span><code>  var eb;</code></div>
<div class="source-line"><span class="line-number ">520</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">521</span><span class="line-counter cline-yes">&nbsp</span><code>  // get the length of the modulus in bytes</code></div>
<div class="source-line"><span class="line-number ">522</span><span class="line-counter cline-yes">&nbsp</span><code>  var k = Math.ceil(key.n.bitLength() / 8);</code></div>
<div class="source-line"><span class="line-number ">523</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">524</span><span class="line-counter cline-yes">&nbsp</span><code>  if(bt !== false &amp;&amp; bt !== true) {</code></div>
<div class="source-line"><span class="line-number ">525</span><span class="line-counter cline-yes">&nbsp</span><code>    // legacy, default to PKCS#1 v1.5 padding</code></div>
<div class="source-line"><span class="line-number ">526</span><span class="line-counter cline-yes">&nbsp</span><code>    pub = (bt === 0x02);</code></div>
<div class="source-line"><span class="line-number ">527</span><span class="line-counter cline-yes">&nbsp</span><code>    eb = _encodePkcs1_v1_5(m, key, bt);</code></div>
<div class="source-line"><span class="line-number ">528</span><span class="line-counter cline-no">！</span><code><span>  }</span><span class="cstat-no" title="statement not covered"> else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">529</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    eb = forge.util.createBuffer();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">530</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    eb.putBytes(m);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">531</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">532</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">533</span><span class="line-counter cline-yes">&nbsp</span><code>  // load encryption block as big integer &#39;x&#39;</code></div>
<div class="source-line"><span class="line-number ">534</span><span class="line-counter cline-yes">&nbsp</span><code>  // FIXME: hex conversion inefficient, get BigInteger w/byte strings</code></div>
<div class="source-line"><span class="line-number ">535</span><span class="line-counter cline-yes">&nbsp</span><code>  var x = new BigInteger(eb.toHex(), 16);</code></div>
<div class="source-line"><span class="line-number ">536</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">537</span><span class="line-counter cline-yes">&nbsp</span><code>  // do RSA encryption</code></div>
<div class="source-line"><span class="line-number ">538</span><span class="line-counter cline-yes">&nbsp</span><code>  var y = _modPow(x, key, pub);</code></div>
<div class="source-line"><span class="line-number ">539</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">540</span><span class="line-counter cline-yes">&nbsp</span><code>  // convert y into the encrypted data byte string, if y is shorter in</code></div>
<div class="source-line"><span class="line-number ">541</span><span class="line-counter cline-yes">&nbsp</span><code>  // bytes than k, then prepend zero bytes to fill up ed</code></div>
<div class="source-line"><span class="line-number ">542</span><span class="line-counter cline-yes">&nbsp</span><code>  // FIXME: hex conversion inefficient, get BigInteger w/byte strings</code></div>
<mark class="issue-line"><div class="source-line"><span class="line-number ">543</span><span class="line-counter cline-yes">&nbsp</span><code>  var yhex = y.toString(16);</code></div>
</mark><details class="issue-inline-message issue-major issue-memory-access target-RSASIGN">
                        <summary>🚨&nbsp;<i>RSASIGN</i> Secret-dependent memory access</summary>
                <div class="issue-description">[RSASIGN] Found vulnerable memory access instruction, leakage score 60.00% +/- 0%.</div>
            </details><div class="source-line"><span class="line-number ">544</span><span class="line-counter cline-yes">&nbsp</span><code>  var ed = forge.util.createBuffer();</code></div>
<div class="source-line"><span class="line-number ">545</span><span class="line-counter cline-yes">&nbsp</span><code>  var zeros = k - Math.ceil(yhex.length / 2);</code></div>
<div class="source-line"><span class="line-number ">546</span><span class="line-counter cline-no">！</span><code><span>  while(zeros &gt; 0) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">547</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    ed.putByte(0x00);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">548</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    --zeros;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">549</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">550</span><span class="line-counter cline-yes">&nbsp</span><code>  ed.putBytes(forge.util.hexToBytes(yhex));</code></div>
<div class="source-line"><span class="line-number ">551</span><span class="line-counter cline-yes">&nbsp</span><code>  return ed.getBytes();</code></div>
<div class="source-line"><span class="line-number ">552</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">553</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">554</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">555</span><span class="line-counter cline-yes">&nbsp</span><code> * NOTE: THIS METHOD IS DEPRECATED, use &#39;decrypt&#39; on a private key object or</code></div>
<div class="source-line"><span class="line-number ">556</span><span class="line-counter cline-yes">&nbsp</span><code> * &#39;verify&#39; on a public key object instead.</code></div>
<div class="source-line"><span class="line-number ">557</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">558</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs RSA decryption.</code></div>
<div class="source-line"><span class="line-number ">559</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">560</span><span class="line-counter cline-yes">&nbsp</span><code> * The parameter ml controls whether to apply PKCS#1 v1.5 padding</code></div>
<div class="source-line"><span class="line-number ">561</span><span class="line-counter cline-yes">&nbsp</span><code> * or not.  Set ml = false to disable padding removal completely</code></div>
<div class="source-line"><span class="line-number ">562</span><span class="line-counter cline-yes">&nbsp</span><code> * (in order to handle e.g. EMSA-PSS later on) and simply pass back</code></div>
<div class="source-line"><span class="line-number ">563</span><span class="line-counter cline-yes">&nbsp</span><code> * the RSA encryption block.</code></div>
<div class="source-line"><span class="line-number ">564</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">565</span><span class="line-counter cline-yes">&nbsp</span><code> * @param ed the encrypted data to decrypt in as a byte string.</code></div>
<div class="source-line"><span class="line-number ">566</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the RSA key to use.</code></div>
<div class="source-line"><span class="line-number ">567</span><span class="line-counter cline-yes">&nbsp</span><code> * @param pub true for a public key operation, false for private.</code></div>
<div class="source-line"><span class="line-number ">568</span><span class="line-counter cline-yes">&nbsp</span><code> * @param ml the message length, if known, false to disable padding.</code></div>
<div class="source-line"><span class="line-number ">569</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">570</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the decrypted message as a byte string.</code></div>
<div class="source-line"><span class="line-number ">571</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">572</span><span class="line-counter cline-no">！</span><code><span>pki.rsa.decrypt = </span><span class="cstat-no" title="statement not covered">function(ed, key, pub, ml) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">573</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // get the length of the modulus in bytes</span><span></span></code></div>
<div class="source-line"><span class="line-number ">574</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var k = Math.ceil(key.n.bitLength() / 8);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">575</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">576</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // error if the length of the encrypted data ED is not k</span><span></span></code></div>
<div class="source-line"><span class="line-number ">577</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(ed.length !== k) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">578</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var error = new Error(&#39;Encrypted message length is invalid.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">579</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.length = ed.length;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">580</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.expected = k;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">581</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">582</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">583</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">584</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // convert encrypted data into a big integer</span><span></span></code></div>
<div class="source-line"><span class="line-number ">585</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // FIXME: hex conversion inefficient, get BigInteger w/byte strings</span><span></span></code></div>
<div class="source-line"><span class="line-number ">586</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var y = new BigInteger(forge.util.createBuffer(ed).toHex(), 16);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">587</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">588</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // y must be less than the modulus or it wasn&#39;t the result of</span><span></span></code></div>
<div class="source-line"><span class="line-number ">589</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // a previous mod operation (encryption) using that modulus</span><span></span></code></div>
<div class="source-line"><span class="line-number ">590</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(y.compareTo(key.n) &gt;= 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">591</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(&#39;Encrypted message is invalid.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">592</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">593</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">594</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // do RSA decryption</span><span></span></code></div>
<div class="source-line"><span class="line-number ">595</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var x = _modPow(y, key, pub);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">596</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">597</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // create the encryption block, if x is shorter in bytes than k, then</span><span></span></code></div>
<div class="source-line"><span class="line-number ">598</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // prepend zero bytes to fill up eb</span><span></span></code></div>
<div class="source-line"><span class="line-number ">599</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // FIXME: hex conversion inefficient, get BigInteger w/byte strings</span><span></span></code></div>
<div class="source-line"><span class="line-number ">600</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var xhex = x.toString(16);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">601</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var eb = forge.util.createBuffer();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">602</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var zeros = k - Math.ceil(xhex.length / 2);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">603</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  while(zeros &gt; 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">604</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    eb.putByte(0x00);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">605</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    --zeros;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">606</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">607</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  eb.putBytes(forge.util.hexToBytes(xhex));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">608</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">609</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(ml !== false) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">610</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // legacy, default to PKCS#1 v1.5 padding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">611</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return _decodePkcs1_v1_5(eb.getBytes(), key, pub);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">612</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">613</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">614</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // return message</span><span></span></code></div>
<div class="source-line"><span class="line-number ">615</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return eb.getBytes();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">616</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">617</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">618</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">619</span><span class="line-counter cline-yes">&nbsp</span><code> * Creates an RSA key-pair generation state object. It is used to allow</code></div>
<div class="source-line"><span class="line-number ">620</span><span class="line-counter cline-yes">&nbsp</span><code> * key-generation to be performed in steps. It also allows for a UI to</code></div>
<div class="source-line"><span class="line-number ">621</span><span class="line-counter cline-yes">&nbsp</span><code> * display progress updates.</code></div>
<div class="source-line"><span class="line-number ">622</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">623</span><span class="line-counter cline-yes">&nbsp</span><code> * @param bits the size for the private key in bits, defaults to 2048.</code></div>
<div class="source-line"><span class="line-number ">624</span><span class="line-counter cline-yes">&nbsp</span><code> * @param e the public exponent to use, defaults to 65537 (0x10001).</code></div>
<div class="source-line"><span class="line-number ">625</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [options] the options to use.</code></div>
<div class="source-line"><span class="line-number ">626</span><span class="line-counter cline-yes">&nbsp</span><code> *          prng a custom crypto-secure pseudo-random number generator to use,</code></div>
<div class="source-line"><span class="line-number ">627</span><span class="line-counter cline-yes">&nbsp</span><code> *            that must define &quot;getBytesSync&quot;.</code></div>
<div class="source-line"><span class="line-number ">628</span><span class="line-counter cline-yes">&nbsp</span><code> *          algorithm the algorithm to use (default: &#39;PRIMEINC&#39;).</code></div>
<div class="source-line"><span class="line-number ">629</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">630</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the state object to use to generate the key-pair.</code></div>
<div class="source-line"><span class="line-number ">631</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">632</span><span class="line-counter cline-no">！</span><code><span>pki.rsa.createKeyPairGenerationState = </span><span class="cstat-no" title="statement not covered">function(bits, e, options) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">633</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // TODO: migrate step-based prime generation code to forge.prime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">634</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">635</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // set default bits</span><span></span></code></div>
<div class="source-line"><span class="line-number ">636</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(typeof(bits) === &#39;string&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">637</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    bits = parseInt(bits, 10);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">638</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">639</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  bits = bits || 2048;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">640</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">641</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // create prng with api that matches BigInteger secure random</span><span></span></code></div>
<div class="source-line"><span class="line-number ">642</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  options = options || {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">643</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var prng = options.prng || forge.random;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">644</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var rng = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">645</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // x is an array to fill with bytes</span><span></span></code></div>
<div class="source-line"><span class="line-number ">646</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    nextBytes: function(x) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">647</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var b = prng.getBytesSync(x.length);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">648</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      for(var i = 0; i &lt; x.length; ++i) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">649</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        x[i] = b.charCodeAt(i);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">650</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">651</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">652</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">653</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">654</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var algorithm = options.algorithm || &#39;PRIMEINC&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">655</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">656</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // create PRIMEINC algorithm state</span><span></span></code></div>
<div class="source-line"><span class="line-number ">657</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var rval;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">658</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(algorithm === &#39;PRIMEINC&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">659</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    rval = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">660</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      algorithm: algorithm,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">661</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state: 0,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">662</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      bits: bits,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">663</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      rng: rng,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">664</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      eInt: e || 65537,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">665</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      e: new BigInteger(null),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">666</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      p: null,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">667</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      q: null,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">668</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      qBits: bits &gt;&gt; 1,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">669</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      pBits: bits - (bits &gt;&gt; 1),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">670</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      pqState: 0,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">671</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      num: null,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">672</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      keys: null</span><span></span></code></div>
<div class="source-line"><span class="line-number ">673</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">674</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    rval.e.fromInt(rval.eInt);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">675</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">676</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(&#39;Invalid key generation algorithm: &#39; + algorithm);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">677</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">678</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">679</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return rval;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">680</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">681</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">682</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">683</span><span class="line-counter cline-yes">&nbsp</span><code> * Attempts to runs the key-generation algorithm for at most n seconds</code></div>
<div class="source-line"><span class="line-number ">684</span><span class="line-counter cline-yes">&nbsp</span><code> * (approximately) using the given state. When key-generation has completed,</code></div>
<div class="source-line"><span class="line-number ">685</span><span class="line-counter cline-yes">&nbsp</span><code> * the keys will be stored in state.keys.</code></div>
<div class="source-line"><span class="line-number ">686</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">687</span><span class="line-counter cline-yes">&nbsp</span><code> * To use this function to update a UI while generating a key or to prevent</code></div>
<div class="source-line"><span class="line-number ">688</span><span class="line-counter cline-yes">&nbsp</span><code> * causing browser lockups/warnings, set &quot;n&quot; to a value other than 0. A</code></div>
<div class="source-line"><span class="line-number ">689</span><span class="line-counter cline-yes">&nbsp</span><code> * simple pattern for generating a key and showing a progress indicator is:</code></div>
<div class="source-line"><span class="line-number ">690</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">691</span><span class="line-counter cline-yes">&nbsp</span><code> * var state = pki.rsa.createKeyPairGenerationState(2048);</code></div>
<div class="source-line"><span class="line-number ">692</span><span class="line-counter cline-yes">&nbsp</span><code> * var step = function() {</code></div>
<div class="source-line"><span class="line-number ">693</span><span class="line-counter cline-yes">&nbsp</span><code> *   // step key-generation, run algorithm for 100 ms, repeat</code></div>
<div class="source-line"><span class="line-number ">694</span><span class="line-counter cline-yes">&nbsp</span><code> *   if(!forge.pki.rsa.stepKeyPairGenerationState(state, 100)) {</code></div>
<div class="source-line"><span class="line-number ">695</span><span class="line-counter cline-yes">&nbsp</span><code> *     setTimeout(step, 1);</code></div>
<div class="source-line"><span class="line-number ">696</span><span class="line-counter cline-yes">&nbsp</span><code> *   } else {</code></div>
<div class="source-line"><span class="line-number ">697</span><span class="line-counter cline-yes">&nbsp</span><code> *     // key-generation complete</code></div>
<div class="source-line"><span class="line-number ">698</span><span class="line-counter cline-yes">&nbsp</span><code> *     // TODO: turn off progress indicator here</code></div>
<div class="source-line"><span class="line-number ">699</span><span class="line-counter cline-yes">&nbsp</span><code> *     // TODO: use the generated key-pair in &quot;state.keys&quot;</code></div>
<div class="source-line"><span class="line-number ">700</span><span class="line-counter cline-yes">&nbsp</span><code> *   }</code></div>
<div class="source-line"><span class="line-number ">701</span><span class="line-counter cline-yes">&nbsp</span><code> * };</code></div>
<div class="source-line"><span class="line-number ">702</span><span class="line-counter cline-yes">&nbsp</span><code> * // TODO: turn on progress indicator here</code></div>
<div class="source-line"><span class="line-number ">703</span><span class="line-counter cline-yes">&nbsp</span><code> * setTimeout(step, 0);</code></div>
<div class="source-line"><span class="line-number ">704</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">705</span><span class="line-counter cline-yes">&nbsp</span><code> * @param state the state to use.</code></div>
<div class="source-line"><span class="line-number ">706</span><span class="line-counter cline-yes">&nbsp</span><code> * @param n the maximum number of milliseconds to run the algorithm for, 0</code></div>
<div class="source-line"><span class="line-number ">707</span><span class="line-counter cline-yes">&nbsp</span><code> *          to run the algorithm to completion.</code></div>
<div class="source-line"><span class="line-number ">708</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">709</span><span class="line-counter cline-yes">&nbsp</span><code> * @return true if the key-generation completed, false if not.</code></div>
<div class="source-line"><span class="line-number ">710</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">711</span><span class="line-counter cline-no">！</span><code><span>pki.rsa.stepKeyPairGenerationState = </span><span class="cstat-no" title="statement not covered">function(state, n) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">712</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // set default algorithm if not set</span><span></span></code></div>
<div class="source-line"><span class="line-number ">713</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(!(&#39;algorithm&#39; in state)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">714</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.algorithm = &#39;PRIMEINC&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">715</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">716</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">717</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // TODO: migrate step-based prime generation code to forge.prime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">718</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // TODO: abstract as PRIMEINC algorithm</span><span></span></code></div>
<div class="source-line"><span class="line-number ">719</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">720</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // do key generation (based on Tom Wu&#39;s rsa.js, see jsbn.js license)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">721</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // with some minor optimizations and designed to run in steps</span><span></span></code></div>
<div class="source-line"><span class="line-number ">722</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">723</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // local state vars</span><span></span></code></div>
<div class="source-line"><span class="line-number ">724</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var THIRTY = new BigInteger(null);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">725</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  THIRTY.fromInt(30);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">726</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var deltaIdx = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">727</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var op_or = function(x, y) {return x | y;};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">728</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">729</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // keep stepping until time limit is reached or done</span><span></span></code></div>
<div class="source-line"><span class="line-number ">730</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var t1 = +new Date();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">731</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var t2;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">732</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var total = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">733</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  while(state.keys === null &amp;&amp; (n &lt;= 0 || total &lt; n)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">734</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // generate p or q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">735</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.state === 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">736</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      /* Note: All primes are of the form:</span><span></span></code></div>
<div class="source-line"><span class="line-number ">737</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">738</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        30k+i, for i &lt; 30 and gcd(30, i)=1, where there are 8 values for i</span><span></span></code></div>
<div class="source-line"><span class="line-number ">739</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">740</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        When we generate a random number, we always align it at 30k + 1. Each</span><span></span></code></div>
<div class="source-line"><span class="line-number ">741</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        time the number is determined not to be prime we add to get to the</span><span></span></code></div>
<div class="source-line"><span class="line-number ">742</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        next &#39;i&#39;, eg: if the number was at 30k + 1 we add 6. */</span><span></span></code></div>
<div class="source-line"><span class="line-number ">743</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var bits = (state.p === null) ? state.pBits : state.qBits;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">744</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var bits1 = bits - 1;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">745</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">746</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // get a random number</span><span></span></code></div>
<div class="source-line"><span class="line-number ">747</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(state.pqState === 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">748</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.num = new BigInteger(bits, state.rng);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">749</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // force MSB set</span><span></span></code></div>
<div class="source-line"><span class="line-number ">750</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        if(!state.num.testBit(bits1)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">751</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.num.bitwiseTo(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">752</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            BigInteger.ONE.shiftLeft(bits1), op_or, state.num);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">753</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">754</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // align number on 30k+1 boundary</span><span></span></code></div>
<div class="source-line"><span class="line-number ">755</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.num.dAddOffset(31 - state.num.mod(THIRTY).byteValue(), 0);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">756</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        deltaIdx = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">757</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">758</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        ++state.pqState;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">759</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else if(state.pqState === 1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">760</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // try to make the number a prime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">761</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        if(state.num.bitLength() &gt; bits) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">762</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // overflow, try again</span><span></span></code></div>
<div class="source-line"><span class="line-number ">763</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.pqState = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">764</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // do primality test</span><span></span></code></div>
<div class="source-line"><span class="line-number ">765</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        } else if(state.num.isProbablePrime(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">766</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          _getMillerRabinTests(state.num.bitLength()))) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">767</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          ++state.pqState;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">768</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">769</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // get next potential prime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">770</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.num.dAddOffset(GCD_30_DELTA[deltaIdx++ % 8], 0);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">771</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">772</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else if(state.pqState === 2) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">773</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // ensure number is coprime with e</span><span></span></code></div>
<div class="source-line"><span class="line-number ">774</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.pqState =</span><span></span></code></div>
<div class="source-line"><span class="line-number ">775</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          (state.num.subtract(BigInteger.ONE).gcd(state.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">776</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            .compareTo(BigInteger.ONE) === 0) ? 3 : 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">777</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else if(state.pqState === 3) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">778</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // store p or q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">779</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.pqState = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">780</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        if(state.p === null) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">781</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.p = state.num;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">782</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">783</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.q = state.num;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">784</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">785</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">786</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // advance state if both p and q are ready</span><span></span></code></div>
<div class="source-line"><span class="line-number ">787</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        if(state.p !== null &amp;&amp; state.q !== null) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">788</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          ++state.state;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">789</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">790</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.num = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">791</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">792</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(state.state === 1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">793</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // ensure p is larger than q (swap them if not)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">794</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(state.p.compareTo(state.q) &lt; 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">795</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.num = state.p;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">796</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.p = state.q;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">797</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.q = state.num;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">798</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">799</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      ++state.state;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">800</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(state.state === 2) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">801</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // compute phi: (p - 1)(q - 1) (Euler&#39;s totient function)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">802</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.p1 = state.p.subtract(BigInteger.ONE);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">803</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.q1 = state.q.subtract(BigInteger.ONE);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">804</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.phi = state.p1.multiply(state.q1);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">805</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      ++state.state;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">806</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(state.state === 3) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">807</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // ensure e and phi are coprime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">808</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(state.phi.gcd(state.e).compareTo(BigInteger.ONE) === 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">809</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // phi and e are coprime, advance</span><span></span></code></div>
<div class="source-line"><span class="line-number ">810</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        ++state.state;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">811</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">812</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // phi and e aren&#39;t coprime, so generate a new p and q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">813</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.p = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">814</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.q = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">815</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.state = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">816</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">817</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(state.state === 4) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">818</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // create n, ensure n is has the right number of bits</span><span></span></code></div>
<div class="source-line"><span class="line-number ">819</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.n = state.p.multiply(state.q);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">820</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">821</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // ensure n is right number of bits</span><span></span></code></div>
<div class="source-line"><span class="line-number ">822</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(state.n.bitLength() === state.bits) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">823</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // success, advance</span><span></span></code></div>
<div class="source-line"><span class="line-number ">824</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        ++state.state;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">825</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">826</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // failed, get new q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">827</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.q = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">828</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.state = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">829</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">830</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(state.state === 5) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">831</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // set keys</span><span></span></code></div>
<div class="source-line"><span class="line-number ">832</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var d = state.e.modInverse(state.phi);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">833</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.keys = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">834</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        privateKey: pki.rsa.setPrivateKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">835</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.n, state.e, d, state.p, state.q,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">836</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          d.mod(state.p1), d.mod(state.q1),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">837</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          state.q.modInverse(state.p)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">838</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        publicKey: pki.rsa.setPublicKey(state.n, state.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">839</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">840</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">841</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">842</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // update timing</span><span></span></code></div>
<div class="source-line"><span class="line-number ">843</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    t2 = +new Date();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">844</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    total += t2 - t1;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">845</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    t1 = t2;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">846</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">847</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">848</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return state.keys !== null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">849</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">850</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">851</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">852</span><span class="line-counter cline-yes">&nbsp</span><code> * Generates an RSA public-private key pair in a single call.</code></div>
<div class="source-line"><span class="line-number ">853</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">854</span><span class="line-counter cline-yes">&nbsp</span><code> * To generate a key-pair in steps (to allow for progress updates and to</code></div>
<div class="source-line"><span class="line-number ">855</span><span class="line-counter cline-yes">&nbsp</span><code> * prevent blocking or warnings in slow browsers) then use the key-pair</code></div>
<div class="source-line"><span class="line-number ">856</span><span class="line-counter cline-yes">&nbsp</span><code> * generation state functions.</code></div>
<div class="source-line"><span class="line-number ">857</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">858</span><span class="line-counter cline-yes">&nbsp</span><code> * To generate a key-pair asynchronously (either through web-workers, if</code></div>
<div class="source-line"><span class="line-number ">859</span><span class="line-counter cline-yes">&nbsp</span><code> * available, or by breaking up the work on the main thread), pass a</code></div>
<div class="source-line"><span class="line-number ">860</span><span class="line-counter cline-yes">&nbsp</span><code> * callback function.</code></div>
<div class="source-line"><span class="line-number ">861</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">862</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [bits] the size for the private key in bits, defaults to 2048.</code></div>
<div class="source-line"><span class="line-number ">863</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [e] the public exponent to use, defaults to 65537.</code></div>
<div class="source-line"><span class="line-number ">864</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [options] options for key-pair generation, if given then &#39;bits&#39;</code></div>
<div class="source-line"><span class="line-number ">865</span><span class="line-counter cline-yes">&nbsp</span><code> *            and &#39;e&#39; must *not* be given:</code></div>
<div class="source-line"><span class="line-number ">866</span><span class="line-counter cline-yes">&nbsp</span><code> *          bits the size for the private key in bits, (default: 2048).</code></div>
<div class="source-line"><span class="line-number ">867</span><span class="line-counter cline-yes">&nbsp</span><code> *          e the public exponent to use, (default: 65537 (0x10001)).</code></div>
<div class="source-line"><span class="line-number ">868</span><span class="line-counter cline-yes">&nbsp</span><code> *          workerScript the worker script URL.</code></div>
<div class="source-line"><span class="line-number ">869</span><span class="line-counter cline-yes">&nbsp</span><code> *          workers the number of web workers (if supported) to use,</code></div>
<div class="source-line"><span class="line-number ">870</span><span class="line-counter cline-yes">&nbsp</span><code> *            (default: 2).</code></div>
<div class="source-line"><span class="line-number ">871</span><span class="line-counter cline-yes">&nbsp</span><code> *          workLoad the size of the work load, ie: number of possible prime</code></div>
<div class="source-line"><span class="line-number ">872</span><span class="line-counter cline-yes">&nbsp</span><code> *            numbers for each web worker to check per work assignment,</code></div>
<div class="source-line"><span class="line-number ">873</span><span class="line-counter cline-yes">&nbsp</span><code> *            (default: 100).</code></div>
<div class="source-line"><span class="line-number ">874</span><span class="line-counter cline-yes">&nbsp</span><code> *          prng a custom crypto-secure pseudo-random number generator to use,</code></div>
<div class="source-line"><span class="line-number ">875</span><span class="line-counter cline-yes">&nbsp</span><code> *            that must define &quot;getBytesSync&quot;. Disables use of native APIs.</code></div>
<div class="source-line"><span class="line-number ">876</span><span class="line-counter cline-yes">&nbsp</span><code> *          algorithm the algorithm to use (default: &#39;PRIMEINC&#39;).</code></div>
<div class="source-line"><span class="line-number ">877</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [callback(err, keypair)] called once the operation completes.</code></div>
<div class="source-line"><span class="line-number ">878</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">879</span><span class="line-counter cline-yes">&nbsp</span><code> * @return an object with privateKey and publicKey properties.</code></div>
<div class="source-line"><span class="line-number ">880</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">881</span><span class="line-counter cline-no">！</span><code><span>pki.rsa.generateKeyPair = </span><span class="cstat-no" title="statement not covered">function(bits, e, options, callback) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">882</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // (bits), (options), (callback)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">883</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(arguments.length === 1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">884</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof bits === &#39;object&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">885</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options = bits;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">886</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      bits = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">887</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(typeof bits === &#39;function&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">888</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      callback = bits;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">889</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      bits = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">890</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">891</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  } else if(arguments.length === 2) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">892</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // (bits, e), (bits, options), (bits, callback), (options, callback)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">893</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof bits === &#39;number&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">894</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(typeof e === &#39;function&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">895</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        callback = e;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">896</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        e = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">897</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      } else if(typeof e !== &#39;number&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">898</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        options = e;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">899</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        e = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">900</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">901</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">902</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options = bits;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">903</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      callback = e;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">904</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      bits = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">905</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      e = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">906</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">907</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  } else if(arguments.length === 3) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">908</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // (bits, e, options), (bits, e, callback), (bits, options, callback)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">909</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof e === &#39;number&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">910</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(typeof options === &#39;function&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">911</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        callback = options;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">912</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        options = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">913</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">914</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">915</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      callback = options;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">916</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options = e;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">917</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      e = undefined;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">918</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">919</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">920</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  options = options || {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">921</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">922</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    bits = options.bits || 2048;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">923</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">924</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(e === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">925</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    e = options.e || 0x10001;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">926</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">927</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">928</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // use native code if permitted, available, and parameters are acceptable</span><span></span></code></div>
<div class="source-line"><span class="line-number ">929</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(!forge.options.usePureJavaScript &amp;&amp; !options.prng &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">930</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    bits &gt;= 256 &amp;&amp; bits &lt;= 16384 &amp;&amp; (e === 0x10001 || e === 3)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">931</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(callback) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">932</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // try native async</span><span></span></code></div>
<div class="source-line"><span class="line-number ">933</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(_detectNodeCrypto(&#39;generateKeyPair&#39;)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">934</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return _crypto.generateKeyPair(&#39;rsa&#39;, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">935</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          modulusLength: bits,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">936</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicExponent: e,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">937</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicKeyEncoding: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">938</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            type: &#39;spki&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">939</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            format: &#39;pem&#39;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">940</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          },</span><span></span></code></div>
<div class="source-line"><span class="line-number ">941</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          privateKeyEncoding: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">942</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            type: &#39;pkcs8&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">943</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            format: &#39;pem&#39;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">944</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">945</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }, function(err, pub, priv) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">946</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          if(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">947</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            return callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">948</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">949</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          callback(null, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">950</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            privateKey: pki.privateKeyFromPem(priv),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">951</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            publicKey: pki.publicKeyFromPem(pub)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">952</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">953</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">954</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">955</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(_detectSubtleCrypto(&#39;generateKey&#39;) &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">956</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        _detectSubtleCrypto(&#39;exportKey&#39;)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">957</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // use standard native generateKey</span><span></span></code></div>
<div class="source-line"><span class="line-number ">958</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return util.globalScope.crypto.subtle.generateKey({</span><span></span></code></div>
<div class="source-line"><span class="line-number ">959</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          name: &#39;RSASSA-PKCS1-v1_5&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">960</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          modulusLength: bits,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">961</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicExponent: _intToUint8Array(e),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">962</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          hash: {name: &#39;SHA-256&#39;}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">963</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }, true /* key can be exported*/, [&#39;sign&#39;, &#39;verify&#39;])</span><span></span></code></div>
<div class="source-line"><span class="line-number ">964</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        .then(function(pair) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">965</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return util.globalScope.crypto.subtle.exportKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">966</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            &#39;pkcs8&#39;, pair.privateKey);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">967</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        // avoiding catch(function(err) {...}) to support IE &lt;= 8</span><span></span></code></div>
<div class="source-line"><span class="line-number ">968</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }).then(undefined, function(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">969</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">970</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }).then(function(pkcs8) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">971</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          if(pkcs8) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">972</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            var privateKey = pki.privateKeyFromAsn1(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">973</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              asn1.fromDer(forge.util.createBuffer(pkcs8)));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">974</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            callback(null, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">975</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              privateKey: privateKey,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">976</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              publicKey: pki.setRsaPublicKey(privateKey.n, privateKey.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">977</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">978</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">979</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">980</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">981</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(_detectSubtleMsCrypto(&#39;generateKey&#39;) &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">982</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        _detectSubtleMsCrypto(&#39;exportKey&#39;)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">983</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        var genOp = util.globalScope.msCrypto.subtle.generateKey({</span><span></span></code></div>
<div class="source-line"><span class="line-number ">984</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          name: &#39;RSASSA-PKCS1-v1_5&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">985</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          modulusLength: bits,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">986</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicExponent: _intToUint8Array(e),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">987</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          hash: {name: &#39;SHA-256&#39;}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">988</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }, true /* key can be exported*/, [&#39;sign&#39;, &#39;verify&#39;]);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">989</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        genOp.oncomplete = function(e) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">990</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var pair = e.target.result;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">991</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var exportOp = util.globalScope.msCrypto.subtle.exportKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">992</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            &#39;pkcs8&#39;, pair.privateKey);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">993</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          exportOp.oncomplete = function(e) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">994</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            var pkcs8 = e.target.result;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">995</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            var privateKey = pki.privateKeyFromAsn1(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">996</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              asn1.fromDer(forge.util.createBuffer(pkcs8)));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">997</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            callback(null, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">998</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              privateKey: privateKey,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">999</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              publicKey: pki.setRsaPublicKey(privateKey.n, privateKey.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1000</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1001</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1002</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          exportOp.onerror = function(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1003</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1004</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1005</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1006</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        genOp.onerror = function(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1007</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1008</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1009</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1010</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1011</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1012</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // try native sync</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1013</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(_detectNodeCrypto(&#39;generateKeyPairSync&#39;)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1014</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        var keypair = _crypto.generateKeyPairSync(&#39;rsa&#39;, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1015</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          modulusLength: bits,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1016</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicExponent: e,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1017</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicKeyEncoding: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1018</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            type: &#39;spki&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1019</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            format: &#39;pem&#39;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1020</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          },</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1021</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          privateKeyEncoding: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1022</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            type: &#39;pkcs8&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1023</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            format: &#39;pem&#39;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1024</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1025</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1026</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1027</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          privateKey: pki.privateKeyFromPem(keypair.privateKey),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1028</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          publicKey: pki.publicKeyFromPem(keypair.publicKey)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1029</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1030</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1031</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1032</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1033</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1034</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // use JavaScript implementation</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1035</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var state = pki.rsa.createKeyPairGenerationState(bits, e, options);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1036</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(!callback) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1037</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    pki.rsa.stepKeyPairGenerationState(state, 0);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1038</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return state.keys;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1039</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1040</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  _generateKeyPair(state, options, callback);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1041</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1042</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1043</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1044</span><span class="line-counter cline-yes">&nbsp</span><code> * Sets an RSA public key from BigIntegers modulus and exponent.</code></div>
<div class="source-line"><span class="line-number ">1045</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1046</span><span class="line-counter cline-yes">&nbsp</span><code> * @param n the modulus.</code></div>
<div class="source-line"><span class="line-number ">1047</span><span class="line-counter cline-yes">&nbsp</span><code> * @param e the exponent.</code></div>
<div class="source-line"><span class="line-number ">1048</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1049</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the public key.</code></div>
<div class="source-line"><span class="line-number ">1050</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1051</span><span class="line-counter cline-no">！</span><code><span>pki.setRsaPublicKey = pki.rsa.setPublicKey = </span><span class="cstat-no" title="statement not covered">function(n, e) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1052</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var key = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1053</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    n: n,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1054</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    e: e</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1055</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1056</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1057</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  /**</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1058</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * Encrypts the given data with this public key. Newer applications</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1059</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * should use the &#39;RSA-OAEP&#39; decryption scheme, &#39;RSAES-PKCS1-V1_5&#39; is for</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1060</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * legacy applications.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1061</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1062</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param data the byte string to encrypt.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1063</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param scheme the encryption scheme to use:</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1064</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          &#39;RSAES-PKCS1-V1_5&#39; (default),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1065</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          &#39;RSA-OAEP&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1066</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          &#39;RAW&#39;, &#39;NONE&#39;, or null to perform raw RSA encryption,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1067</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          an object with an &#39;encode&#39; property set to a function</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1068</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          with the signature &#39;function(data, key)&#39; that returns</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1069</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          a binary-encoded string representing the encoded data.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1070</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param schemeOptions any scheme-specific options.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1071</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1072</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @return the encrypted byte string.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1073</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   */</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1074</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  key.encrypt = function(data, scheme, schemeOptions) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1075</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof scheme === &#39;string&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1076</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = scheme.toUpperCase();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1077</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1078</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = &#39;RSAES-PKCS1-V1_5&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1079</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1080</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1081</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(scheme === &#39;RSAES-PKCS1-V1_5&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1082</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1083</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        encode: function(m, key, pub) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1084</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return _encodePkcs1_v1_5(m, key, 0x02).getBytes();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1085</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1086</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1087</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === &#39;RSA-OAEP&#39; || scheme === &#39;RSAES-OAEP&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1088</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1089</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        encode: function(m, key) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1090</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return forge.pkcs1.encode_rsa_oaep(key, m, schemeOptions);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1091</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1092</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1093</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if([&#39;RAW&#39;, &#39;NONE&#39;, &#39;NULL&#39;, null].indexOf(scheme) !== -1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1094</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {encode: function(e) {return e;}};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1095</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(typeof scheme === &#39;string&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1096</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      throw new Error(&#39;Unsupported encryption scheme: &quot;&#39; + scheme + &#39;&quot;.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1097</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1098</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1099</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // do scheme-based encoding then rsa encryption</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1100</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var e = scheme.encode(data, key, true);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1101</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return pki.rsa.encrypt(e, key, true);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1102</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1103</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1104</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  /**</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1105</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * Verifies the given signature against the given digest.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1106</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1107</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * PKCS#1 supports multiple (currently two) signature schemes:</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1108</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * RSASSA-PKCS1-V1_5 and RSASSA-PSS.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1109</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1110</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * By default this implementation uses the &quot;old scheme&quot;, i.e.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1111</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * RSASSA-PKCS1-V1_5, in which case once RSA-decrypted, the</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1112</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * signature is an OCTET STRING that holds a DigestInfo.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1113</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1114</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * DigestInfo ::= SEQUENCE {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1115</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *   digestAlgorithm DigestAlgorithmIdentifier,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1116</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *   digest Digest</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1117</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1118</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * DigestAlgorithmIdentifier ::= AlgorithmIdentifier</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1119</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * Digest ::= OCTET STRING</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1120</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1121</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * To perform PSS signature verification, provide an instance</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1122</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * of Forge PSS object as the scheme parameter.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1123</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1124</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param digest the message digest hash to compare against the signature,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1125</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          as a binary-encoded string.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1126</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param signature the signature to verify, as a binary-encoded string.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1127</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param scheme signature verification scheme to use:</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1128</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          &#39;RSASSA-PKCS1-V1_5&#39; or undefined for RSASSA PKCS#1 v1.5,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1129</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          a Forge PSS object for RSASSA-PSS,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1130</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          &#39;NONE&#39; or null for none, DigestInfo will not be expected, but</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1131</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *            PKCS#1 v1.5 padding will still be used.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1132</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @param options optional verify options</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1133</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *          _parseAllDigestBytes testing flag to control parsing of all</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1134</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *            digest bytes. Unsupported and not for general usage.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1135</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *            (default: true)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1136</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   *</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1137</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   * @return true if the signature was verified, false if not.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1138</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   */</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1139</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  key.verify = function(digest, signature, scheme, options) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1140</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof scheme === &#39;string&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1141</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = scheme.toUpperCase();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1142</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1143</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = &#39;RSASSA-PKCS1-V1_5&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1144</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1145</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(options === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1146</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1147</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        _parseAllDigestBytes: true</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1148</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1149</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1150</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(!(&#39;_parseAllDigestBytes&#39; in options)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1151</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options._parseAllDigestBytes = true;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1152</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1153</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1154</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(scheme === &#39;RSASSA-PKCS1-V1_5&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1155</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1156</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        verify: function(digest, d) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1157</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // remove padding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1158</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          d = _decodePkcs1_v1_5(d, key, true);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1159</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // d is ASN.1 BER-encoded DigestInfo</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1160</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var obj = asn1.fromDer(d, {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1161</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            parseAllBytes: options._parseAllDigestBytes</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1162</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1163</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1164</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // validate DigestInfo</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1165</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var capture = {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1166</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var errors = [];</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1167</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          if(!asn1.validate(obj, digestInfoValidator, capture, errors)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1168</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            var error = new Error(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1169</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              &#39;ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 &#39; +</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1170</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              &#39;DigestInfo value.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1171</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            error.errors = errors;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1172</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1173</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1174</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // check hash algorithm identifier</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1175</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // see PKCS1-v1-5DigestAlgorithms in RFC 8017</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1176</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // FIXME: add support to vaidator for strict value choices</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1177</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          var oid = asn1.derToOid(capture.algorithmIdentifier);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1178</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          if(!(oid === forge.oids.md2 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1179</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.md5 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1180</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.sha1 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1181</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.sha224 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1182</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.sha256 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1183</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.sha384 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1184</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids.sha512 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1185</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids[&#39;sha512-224&#39;] ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1186</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            oid === forge.oids[&#39;sha512-256&#39;])) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1187</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            var error = new Error(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1188</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              &#39;Unknown RSASSA-PKCS1-v1_5 DigestAlgorithm identifier.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1189</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            error.oid = oid;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1190</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1191</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1192</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1193</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // special check for md2 and md5 that NULL parameters exist</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1194</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          if(oid === forge.oids.md2 || oid === forge.oids.md5) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1195</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            if(!(&#39;parameters&#39; in capture)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1196</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">              throw new Error(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1197</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">                &#39;ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 &#39; +</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1198</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">                &#39;DigestInfo value. &#39; +</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1199</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">                &#39;Missing algorithm identifer NULL parameters.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1200</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">            }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1201</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1202</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1203</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // compare the given digest to the decrypted one</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1204</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return digest === capture.digest;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1205</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1206</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1207</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === &#39;NONE&#39; || scheme === &#39;NULL&#39; || scheme === null) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1208</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1209</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        verify: function(digest, d) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1210</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          // remove padding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1211</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          d = _decodePkcs1_v1_5(d, key, true);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1212</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return digest === d;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1213</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1214</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1215</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1216</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1217</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // do rsa decryption w/o any decoding, then verify -- which does decoding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1218</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var d = pki.rsa.decrypt(signature, key, true, false);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1219</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return scheme.verify(digest, d, key.n.bitLength());</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1220</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1221</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1222</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return key;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1223</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1224</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1225</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1226</span><span class="line-counter cline-yes">&nbsp</span><code> * Sets an RSA private key from BigIntegers modulus, exponent, primes,</code></div>
<div class="source-line"><span class="line-number ">1227</span><span class="line-counter cline-yes">&nbsp</span><code> * prime exponents, and modular multiplicative inverse.</code></div>
<div class="source-line"><span class="line-number ">1228</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1229</span><span class="line-counter cline-yes">&nbsp</span><code> * @param n the modulus.</code></div>
<div class="source-line"><span class="line-number ">1230</span><span class="line-counter cline-yes">&nbsp</span><code> * @param e the public exponent.</code></div>
<div class="source-line"><span class="line-number ">1231</span><span class="line-counter cline-yes">&nbsp</span><code> * @param d the private exponent ((inverse of e) mod n).</code></div>
<div class="source-line"><span class="line-number ">1232</span><span class="line-counter cline-yes">&nbsp</span><code> * @param p the first prime.</code></div>
<div class="source-line"><span class="line-number ">1233</span><span class="line-counter cline-yes">&nbsp</span><code> * @param q the second prime.</code></div>
<div class="source-line"><span class="line-number ">1234</span><span class="line-counter cline-yes">&nbsp</span><code> * @param dP exponent1 (d mod (p-1)).</code></div>
<div class="source-line"><span class="line-number ">1235</span><span class="line-counter cline-yes">&nbsp</span><code> * @param dQ exponent2 (d mod (q-1)).</code></div>
<div class="source-line"><span class="line-number ">1236</span><span class="line-counter cline-yes">&nbsp</span><code> * @param qInv ((inverse of q) mod p)</code></div>
<div class="source-line"><span class="line-number ">1237</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1238</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the private key.</code></div>
<div class="source-line"><span class="line-number ">1239</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1240</span><span class="line-counter cline-yes">&nbsp</span><code>pki.setRsaPrivateKey = pki.rsa.setPrivateKey = function(</code></div>
<div class="source-line"><span class="line-number ">1241</span><span class="line-counter cline-yes">&nbsp</span><code>  n, e, d, p, q, dP, dQ, qInv) {</code></div>
<div class="source-line"><span class="line-number ">1242</span><span class="line-counter cline-yes">&nbsp</span><code>  var key = {</code></div>
<div class="source-line"><span class="line-number ">1243</span><span class="line-counter cline-yes">&nbsp</span><code>    n: n,</code></div>
<div class="source-line"><span class="line-number ">1244</span><span class="line-counter cline-yes">&nbsp</span><code>    e: e,</code></div>
<div class="source-line"><span class="line-number ">1245</span><span class="line-counter cline-yes">&nbsp</span><code>    d: d,</code></div>
<div class="source-line"><span class="line-number ">1246</span><span class="line-counter cline-yes">&nbsp</span><code>    p: p,</code></div>
<div class="source-line"><span class="line-number ">1247</span><span class="line-counter cline-yes">&nbsp</span><code>    q: q,</code></div>
<div class="source-line"><span class="line-number ">1248</span><span class="line-counter cline-yes">&nbsp</span><code>    dP: dP,</code></div>
<div class="source-line"><span class="line-number ">1249</span><span class="line-counter cline-yes">&nbsp</span><code>    dQ: dQ,</code></div>
<div class="source-line"><span class="line-number ">1250</span><span class="line-counter cline-yes">&nbsp</span><code>    qInv: qInv</code></div>
<div class="source-line"><span class="line-number ">1251</span><span class="line-counter cline-yes">&nbsp</span><code>  };</code></div>
<div class="source-line"><span class="line-number ">1252</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1253</span><span class="line-counter cline-yes">&nbsp</span><code>  /**</code></div>
<div class="source-line"><span class="line-number ">1254</span><span class="line-counter cline-yes">&nbsp</span><code>   * Decrypts the given data with this private key. The decryption scheme</code></div>
<div class="source-line"><span class="line-number ">1255</span><span class="line-counter cline-yes">&nbsp</span><code>   * must match the one used to encrypt the data.</code></div>
<div class="source-line"><span class="line-number ">1256</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1257</span><span class="line-counter cline-yes">&nbsp</span><code>   * @param data the byte string to decrypt.</code></div>
<div class="source-line"><span class="line-number ">1258</span><span class="line-counter cline-yes">&nbsp</span><code>   * @param scheme the decryption scheme to use:</code></div>
<div class="source-line"><span class="line-number ">1259</span><span class="line-counter cline-yes">&nbsp</span><code>   *          &#39;RSAES-PKCS1-V1_5&#39; (default),</code></div>
<div class="source-line"><span class="line-number ">1260</span><span class="line-counter cline-yes">&nbsp</span><code>   *          &#39;RSA-OAEP&#39;,</code></div>
<div class="source-line"><span class="line-number ">1261</span><span class="line-counter cline-yes">&nbsp</span><code>   *          &#39;RAW&#39;, &#39;NONE&#39;, or null to perform raw RSA decryption.</code></div>
<div class="source-line"><span class="line-number ">1262</span><span class="line-counter cline-yes">&nbsp</span><code>   * @param schemeOptions any scheme-specific options.</code></div>
<div class="source-line"><span class="line-number ">1263</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1264</span><span class="line-counter cline-yes">&nbsp</span><code>   * @return the decrypted byte string.</code></div>
<div class="source-line"><span class="line-number ">1265</span><span class="line-counter cline-yes">&nbsp</span><code>   */</code></div>
<div class="source-line"><span class="line-number ">1266</span><span class="line-counter cline-no">！</span><code><span>  key.decrypt = </span><span class="cstat-no" title="statement not covered">function(data, scheme, schemeOptions) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1267</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(typeof scheme === &#39;string&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1268</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = scheme.toUpperCase();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1269</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === undefined) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1270</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = &#39;RSAES-PKCS1-V1_5&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1271</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1272</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1273</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // do rsa decryption w/o any decoding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1274</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var d = pki.rsa.decrypt(data, key, false, false);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1275</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1276</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(scheme === &#39;RSAES-PKCS1-V1_5&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1277</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {decode: _decodePkcs1_v1_5};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1278</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if(scheme === &#39;RSA-OAEP&#39; || scheme === &#39;RSAES-OAEP&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1279</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1280</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        decode: function(d, key) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1281</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          return forge.pkcs1.decode_rsa_oaep(key, d, schemeOptions);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1282</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1283</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1284</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else if([&#39;RAW&#39;, &#39;NONE&#39;, &#39;NULL&#39;, null].indexOf(scheme) !== -1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1285</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = {decode: function(d) {return d;}};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1286</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1287</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      throw new Error(&#39;Unsupported encryption scheme: &quot;&#39; + scheme + &#39;&quot;.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1288</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1289</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1290</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // decode according to scheme</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1291</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return scheme.decode(d, key, false);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1292</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1293</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1294</span><span class="line-counter cline-yes">&nbsp</span><code>  /**</code></div>
<div class="source-line"><span class="line-number ">1295</span><span class="line-counter cline-yes">&nbsp</span><code>   * Signs the given digest, producing a signature.</code></div>
<div class="source-line"><span class="line-number ">1296</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1297</span><span class="line-counter cline-yes">&nbsp</span><code>   * PKCS#1 supports multiple (currently two) signature schemes:</code></div>
<div class="source-line"><span class="line-number ">1298</span><span class="line-counter cline-yes">&nbsp</span><code>   * RSASSA-PKCS1-V1_5 and RSASSA-PSS.</code></div>
<div class="source-line"><span class="line-number ">1299</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1300</span><span class="line-counter cline-yes">&nbsp</span><code>   * By default this implementation uses the &quot;old scheme&quot;, i.e.</code></div>
<div class="source-line"><span class="line-number ">1301</span><span class="line-counter cline-yes">&nbsp</span><code>   * RSASSA-PKCS1-V1_5. In order to generate a PSS signature, provide</code></div>
<div class="source-line"><span class="line-number ">1302</span><span class="line-counter cline-yes">&nbsp</span><code>   * an instance of Forge PSS object as the scheme parameter.</code></div>
<div class="source-line"><span class="line-number ">1303</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1304</span><span class="line-counter cline-yes">&nbsp</span><code>   * @param md the message digest object with the hash to sign.</code></div>
<div class="source-line"><span class="line-number ">1305</span><span class="line-counter cline-yes">&nbsp</span><code>   * @param scheme the signature scheme to use:</code></div>
<div class="source-line"><span class="line-number ">1306</span><span class="line-counter cline-yes">&nbsp</span><code>   *          &#39;RSASSA-PKCS1-V1_5&#39; or undefined for RSASSA PKCS#1 v1.5,</code></div>
<div class="source-line"><span class="line-number ">1307</span><span class="line-counter cline-yes">&nbsp</span><code>   *          a Forge PSS object for RSASSA-PSS,</code></div>
<div class="source-line"><span class="line-number ">1308</span><span class="line-counter cline-yes">&nbsp</span><code>   *          &#39;NONE&#39; or null for none, DigestInfo will not be used but</code></div>
<div class="source-line"><span class="line-number ">1309</span><span class="line-counter cline-yes">&nbsp</span><code>   *            PKCS#1 v1.5 padding will still be used.</code></div>
<div class="source-line"><span class="line-number ">1310</span><span class="line-counter cline-yes">&nbsp</span><code>   *</code></div>
<div class="source-line"><span class="line-number ">1311</span><span class="line-counter cline-yes">&nbsp</span><code>   * @return the signature as a byte string.</code></div>
<div class="source-line"><span class="line-number ">1312</span><span class="line-counter cline-yes">&nbsp</span><code>   */</code></div>
<div class="source-line"><span class="line-number ">1313</span><span class="line-counter cline-yes">&nbsp</span><code>  key.sign = function(md, scheme) {</code></div>
<div class="source-line"><span class="line-number ">1314</span><span class="line-counter cline-yes">&nbsp</span><code>    /* Note: The internal implementation of RSA operations is being</code></div>
<div class="source-line"><span class="line-number ">1315</span><span class="line-counter cline-yes">&nbsp</span><code>      transitioned away from a PKCS#1 v1.5 hard-coded scheme. Some legacy</code></div>
<div class="source-line"><span class="line-number ">1316</span><span class="line-counter cline-yes">&nbsp</span><code>      code like the use of an encoding block identifier &#39;bt&#39; will eventually</code></div>
<div class="source-line"><span class="line-number ">1317</span><span class="line-counter cline-yes">&nbsp</span><code>      be removed. */</code></div>
<div class="source-line"><span class="line-number ">1318</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1319</span><span class="line-counter cline-yes">&nbsp</span><code>    // private key operation</code></div>
<div class="source-line"><span class="line-number ">1320</span><span class="line-counter cline-yes">&nbsp</span><code>    var bt = false;</code></div>
<div class="source-line"><span class="line-number ">1321</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1322</span><span class="line-counter cline-no">！</span><code><span>    if(typeof scheme === &#39;string&#39;) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1323</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      scheme = scheme.toUpperCase();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1324</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1325</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1326</span><span class="line-counter cline-no">！</span><code><span>    if(scheme === undefined </span><span class="cstat-no" title="statement not covered">|| scheme === &#39;RSASSA-PKCS1-V1_5&#39;</span><span>) {</span></code></div>
<div class="source-line"><span class="line-number ">1327</span><span class="line-counter cline-yes">&nbsp</span><code>      scheme = {encode: emsaPkcs1v15encode};</code></div>
<div class="source-line"><span class="line-number ">1328</span><span class="line-counter cline-yes">&nbsp</span><code>      bt = 0x01;</code></div>
<div class="source-line"><span class="line-number ">1329</span><span class="line-counter cline-no">！</span><code><span>    }</span><span class="cstat-no" title="statement not covered"> else if(scheme === &#39;NONE&#39; || scheme === &#39;NULL&#39; || scheme === null) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1330</span><span class="line-counter cline-no">！</span><code><span>      scheme = {encode: </span><span class="cstat-no" title="statement not covered">function() {return md;}</span><span>};</span></code></div>
<div class="source-line"><span class="line-number ">1331</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      bt = 0x01;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1332</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1333</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1334</span><span class="line-counter cline-yes">&nbsp</span><code>    // encode and then encrypt</code></div>
<div class="source-line"><span class="line-number ">1335</span><span class="line-counter cline-yes">&nbsp</span><code>    var d = scheme.encode(md, key.n.bitLength());</code></div>
<div class="source-line"><span class="line-number ">1336</span><span class="line-counter cline-yes">&nbsp</span><code>    return pki.rsa.encrypt(d, key, bt);</code></div>
<div class="source-line"><span class="line-number ">1337</span><span class="line-counter cline-yes">&nbsp</span><code>  };</code></div>
<div class="source-line"><span class="line-number ">1338</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1339</span><span class="line-counter cline-yes">&nbsp</span><code>  return key;</code></div>
<div class="source-line"><span class="line-number ">1340</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">1341</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1342</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1343</span><span class="line-counter cline-yes">&nbsp</span><code> * Wraps an RSAPrivateKey ASN.1 object in an ASN.1 PrivateKeyInfo object.</code></div>
<div class="source-line"><span class="line-number ">1344</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1345</span><span class="line-counter cline-yes">&nbsp</span><code> * @param rsaKey the ASN.1 RSAPrivateKey.</code></div>
<div class="source-line"><span class="line-number ">1346</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1347</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the ASN.1 PrivateKeyInfo.</code></div>
<div class="source-line"><span class="line-number ">1348</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1349</span><span class="line-counter cline-no">！</span><code><span>pki.wrapRsaPrivateKey = </span><span class="cstat-no" title="statement not covered">function(rsaKey) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1350</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // PrivateKeyInfo</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1351</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1352</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // version (0)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1353</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1354</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.integerToDer(0).getBytes()),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1355</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateKeyAlgorithm</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1356</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1357</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.create(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1358</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        asn1.Class.UNIVERSAL, asn1.Type.OID, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1359</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        asn1.oidToDer(pki.oids.rsaEncryption).getBytes()),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1360</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.create(asn1.Class.UNIVERSAL, asn1.Type.NULL, false, &#39;&#39;)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1361</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    ]),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1362</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // PrivateKey</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1363</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.OCTETSTRING, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1364</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.toDer(rsaKey).getBytes())</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1365</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  ]);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1366</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1367</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1368</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1369</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a private key from an ASN.1 object.</code></div>
<div class="source-line"><span class="line-number ">1370</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1371</span><span class="line-counter cline-yes">&nbsp</span><code> * @param obj the ASN.1 representation of a PrivateKeyInfo containing an</code></div>
<div class="source-line"><span class="line-number ">1372</span><span class="line-counter cline-yes">&nbsp</span><code> *          RSAPrivateKey or an RSAPrivateKey.</code></div>
<div class="source-line"><span class="line-number ">1373</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1374</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the private key.</code></div>
<div class="source-line"><span class="line-number ">1375</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1376</span><span class="line-counter cline-yes">&nbsp</span><code>pki.privateKeyFromAsn1 = function(obj) {</code></div>
<div class="source-line"><span class="line-number ">1377</span><span class="line-counter cline-yes">&nbsp</span><code>  // get PrivateKeyInfo</code></div>
<div class="source-line"><span class="line-number ">1378</span><span class="line-counter cline-yes">&nbsp</span><code>  var capture = {};</code></div>
<div class="source-line"><span class="line-number ">1379</span><span class="line-counter cline-yes">&nbsp</span><code>  var errors = [];</code></div>
<div class="source-line"><span class="line-number ">1380</span><span class="line-counter cline-yes">&nbsp</span><code>  if(asn1.validate(obj, privateKeyValidator, capture, errors)) {</code></div>
<div class="source-line"><span class="line-number ">1381</span><span class="line-counter cline-yes">&nbsp</span><code>    obj = asn1.fromDer(forge.util.createBuffer(capture.privateKey));</code></div>
<div class="source-line"><span class="line-number ">1382</span><span class="line-counter cline-yes">&nbsp</span><code>  }</code></div>
<div class="source-line"><span class="line-number ">1383</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1384</span><span class="line-counter cline-yes">&nbsp</span><code>  // get RSAPrivateKey</code></div>
<div class="source-line"><span class="line-number ">1385</span><span class="line-counter cline-yes">&nbsp</span><code>  capture = {};</code></div>
<div class="source-line"><span class="line-number ">1386</span><span class="line-counter cline-yes">&nbsp</span><code>  errors = [];</code></div>
<div class="source-line"><span class="line-number ">1387</span><span class="line-counter cline-no">！</span><code><span>  if(!asn1.validate(obj, rsaPrivateKeyValidator, capture, errors)) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1388</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var error = new Error(&#39;Cannot read private key. &#39; +</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1389</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      &#39;ASN.1 object does not contain an RSAPrivateKey.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1390</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.errors = errors;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1391</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1392</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1393</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1394</span><span class="line-counter cline-yes">&nbsp</span><code>  // Note: Version is currently ignored.</code></div>
<div class="source-line"><span class="line-number ">1395</span><span class="line-counter cline-yes">&nbsp</span><code>  // capture.privateKeyVersion</code></div>
<div class="source-line"><span class="line-number ">1396</span><span class="line-counter cline-yes">&nbsp</span><code>  // FIXME: inefficient, get a BigInteger that uses byte strings</code></div>
<div class="source-line"><span class="line-number ">1397</span><span class="line-counter cline-yes">&nbsp</span><code>  var n, e, d, p, q, dP, dQ, qInv;</code></div>
<div class="source-line"><span class="line-number ">1398</span><span class="line-counter cline-yes">&nbsp</span><code>  n = forge.util.createBuffer(capture.privateKeyModulus).toHex();</code></div>
<div class="source-line"><span class="line-number ">1399</span><span class="line-counter cline-yes">&nbsp</span><code>  e = forge.util.createBuffer(capture.privateKeyPublicExponent).toHex();</code></div>
<div class="source-line"><span class="line-number ">1400</span><span class="line-counter cline-yes">&nbsp</span><code>  d = forge.util.createBuffer(capture.privateKeyPrivateExponent).toHex();</code></div>
<div class="source-line"><span class="line-number ">1401</span><span class="line-counter cline-yes">&nbsp</span><code>  p = forge.util.createBuffer(capture.privateKeyPrime1).toHex();</code></div>
<div class="source-line"><span class="line-number ">1402</span><span class="line-counter cline-yes">&nbsp</span><code>  q = forge.util.createBuffer(capture.privateKeyPrime2).toHex();</code></div>
<div class="source-line"><span class="line-number ">1403</span><span class="line-counter cline-yes">&nbsp</span><code>  dP = forge.util.createBuffer(capture.privateKeyExponent1).toHex();</code></div>
<div class="source-line"><span class="line-number ">1404</span><span class="line-counter cline-yes">&nbsp</span><code>  dQ = forge.util.createBuffer(capture.privateKeyExponent2).toHex();</code></div>
<div class="source-line"><span class="line-number ">1405</span><span class="line-counter cline-yes">&nbsp</span><code>  qInv = forge.util.createBuffer(capture.privateKeyCoefficient).toHex();</code></div>
<div class="source-line"><span class="line-number ">1406</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1407</span><span class="line-counter cline-yes">&nbsp</span><code>  // set private key</code></div>
<div class="source-line"><span class="line-number ">1408</span><span class="line-counter cline-yes">&nbsp</span><code>  return pki.setRsaPrivateKey(</code></div>
<div class="source-line"><span class="line-number ">1409</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(n, 16),</code></div>
<div class="source-line"><span class="line-number ">1410</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(e, 16),</code></div>
<div class="source-line"><span class="line-number ">1411</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(d, 16),</code></div>
<div class="source-line"><span class="line-number ">1412</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(p, 16),</code></div>
<div class="source-line"><span class="line-number ">1413</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(q, 16),</code></div>
<div class="source-line"><span class="line-number ">1414</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(dP, 16),</code></div>
<div class="source-line"><span class="line-number ">1415</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(dQ, 16),</code></div>
<div class="source-line"><span class="line-number ">1416</span><span class="line-counter cline-yes">&nbsp</span><code>    new BigInteger(qInv, 16));</code></div>
<div class="source-line"><span class="line-number ">1417</span><span class="line-counter cline-yes">&nbsp</span><code>};</code></div>
<div class="source-line"><span class="line-number ">1418</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1419</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1420</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a private key to an ASN.1 RSAPrivateKey.</code></div>
<div class="source-line"><span class="line-number ">1421</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1422</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the private key.</code></div>
<div class="source-line"><span class="line-number ">1423</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1424</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the ASN.1 representation of an RSAPrivateKey.</code></div>
<div class="source-line"><span class="line-number ">1425</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1426</span><span class="line-counter cline-no">！</span><code><span>pki.privateKeyToAsn1 = pki.privateKeyToRSAPrivateKey = </span><span class="cstat-no" title="statement not covered">function(key) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1427</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // RSAPrivateKey</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1428</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1429</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // version (0 = only 2 primes, 1 multiple primes)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1430</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1431</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.integerToDer(0).getBytes()),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1432</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // modulus (n)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1433</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1434</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.n)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1435</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // publicExponent (e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1436</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1437</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.e)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1438</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateExponent (d)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1439</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1440</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.d)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1441</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateKeyPrime1 (p)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1442</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1443</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.p)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1444</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateKeyPrime2 (q)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1445</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1446</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.q)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1447</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateKeyExponent1 (dP)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1448</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1449</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.dP)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1450</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // privateKeyExponent2 (dQ)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1451</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1452</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.dQ)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1453</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // coefficient (qInv)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1454</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1455</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.qInv))</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1456</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  ]);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1457</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1458</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1459</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1460</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a public key from an ASN.1 SubjectPublicKeyInfo or RSAPublicKey.</code></div>
<div class="source-line"><span class="line-number ">1461</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1462</span><span class="line-counter cline-yes">&nbsp</span><code> * @param obj the asn1 representation of a SubjectPublicKeyInfo or RSAPublicKey.</code></div>
<div class="source-line"><span class="line-number ">1463</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1464</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the public key.</code></div>
<div class="source-line"><span class="line-number ">1465</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1466</span><span class="line-counter cline-no">！</span><code><span>pki.publicKeyFromAsn1 = </span><span class="cstat-no" title="statement not covered">function(obj) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1467</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // get SubjectPublicKeyInfo</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1468</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var capture = {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1469</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var errors = [];</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1470</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(asn1.validate(obj, publicKeyValidator, capture, errors)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1471</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // get oid</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1472</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var oid = asn1.derToOid(capture.publicKeyOid);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1473</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(oid !== pki.oids.rsaEncryption) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1474</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var error = new Error(&#39;Cannot read public key. Unknown OID.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1475</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      error.oid = oid;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1476</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1477</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1478</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    obj = capture.rsaPublicKey;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1479</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1480</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1481</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // get RSA params</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1482</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  errors = [];</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1483</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(!asn1.validate(obj, rsaPublicKeyValidator, capture, errors)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1484</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var error = new Error(&#39;Cannot read public key. &#39; +</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1485</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      &#39;ASN.1 object does not contain an RSAPublicKey.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1486</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.errors = errors;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1487</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1488</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1489</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1490</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // FIXME: inefficient, get a BigInteger that uses byte strings</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1491</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var n = forge.util.createBuffer(capture.publicKeyModulus).toHex();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1492</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var e = forge.util.createBuffer(capture.publicKeyExponent).toHex();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1493</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1494</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // set public key</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1495</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return pki.setRsaPublicKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1496</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    new BigInteger(n, 16),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1497</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    new BigInteger(e, 16));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1498</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1499</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1500</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1501</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a public key to an ASN.1 SubjectPublicKeyInfo.</code></div>
<div class="source-line"><span class="line-number ">1502</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1503</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the public key.</code></div>
<div class="source-line"><span class="line-number ">1504</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1505</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the asn1 representation of a SubjectPublicKeyInfo.</code></div>
<div class="source-line"><span class="line-number ">1506</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1507</span><span class="line-counter cline-no">！</span><code><span>pki.publicKeyToAsn1 = pki.publicKeyToSubjectPublicKeyInfo = </span><span class="cstat-no" title="statement not covered">function(key) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1508</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // SubjectPublicKeyInfo</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1509</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1510</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // AlgorithmIdentifier</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1511</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1512</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // algorithm</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1513</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.create(asn1.Class.UNIVERSAL, asn1.Type.OID, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1514</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        asn1.oidToDer(pki.oids.rsaEncryption).getBytes()),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1515</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // parameters (null)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1516</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      asn1.create(asn1.Class.UNIVERSAL, asn1.Type.NULL, false, &#39;&#39;)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1517</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    ]),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1518</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // subjectPublicKey</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1519</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.BITSTRING, false, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1520</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      pki.publicKeyToRSAPublicKey(key)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1521</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    ])</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1522</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  ]);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1523</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1524</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1525</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1526</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a public key to an ASN.1 RSAPublicKey.</code></div>
<div class="source-line"><span class="line-number ">1527</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1528</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the public key.</code></div>
<div class="source-line"><span class="line-number ">1529</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1530</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the asn1 representation of a RSAPublicKey.</code></div>
<div class="source-line"><span class="line-number ">1531</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1532</span><span class="line-counter cline-no">！</span><code><span>pki.publicKeyToRSAPublicKey = </span><span class="cstat-no" title="statement not covered">function(key) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1533</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // RSAPublicKey</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1534</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return asn1.create(asn1.Class.UNIVERSAL, asn1.Type.SEQUENCE, true, [</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1535</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // modulus (n)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1536</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1537</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.n)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1538</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // publicExponent (e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1539</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    asn1.create(asn1.Class.UNIVERSAL, asn1.Type.INTEGER, false,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1540</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      _bnToBytes(key.e))</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1541</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  ]);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1542</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span>;</span></code></div>
<div class="source-line"><span class="line-number ">1543</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1544</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1545</span><span class="line-counter cline-yes">&nbsp</span><code> * Encodes a message using PKCS#1 v1.5 padding.</code></div>
<div class="source-line"><span class="line-number ">1546</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1547</span><span class="line-counter cline-yes">&nbsp</span><code> * @param m the message to encode.</code></div>
<div class="source-line"><span class="line-number ">1548</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the RSA key to use.</code></div>
<div class="source-line"><span class="line-number ">1549</span><span class="line-counter cline-yes">&nbsp</span><code> * @param bt the block type to use, i.e. either 0x01 (for signing) or 0x02</code></div>
<div class="source-line"><span class="line-number ">1550</span><span class="line-counter cline-yes">&nbsp</span><code> *          (for encryption).</code></div>
<div class="source-line"><span class="line-number ">1551</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1552</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the padded byte buffer.</code></div>
<div class="source-line"><span class="line-number ">1553</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1554</span><span class="line-counter cline-yes">&nbsp</span><code>function _encodePkcs1_v1_5(m, key, bt) {</code></div>
<div class="source-line"><span class="line-number ">1555</span><span class="line-counter cline-yes">&nbsp</span><code>  var eb = forge.util.createBuffer();</code></div>
<div class="source-line"><span class="line-number ">1556</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1557</span><span class="line-counter cline-yes">&nbsp</span><code>  // get the length of the modulus in bytes</code></div>
<div class="source-line"><span class="line-number ">1558</span><span class="line-counter cline-yes">&nbsp</span><code>  var k = Math.ceil(key.n.bitLength() / 8);</code></div>
<div class="source-line"><span class="line-number ">1559</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1560</span><span class="line-counter cline-yes">&nbsp</span><code>  /* use PKCS#1 v1.5 padding */</code></div>
<div class="source-line"><span class="line-number ">1561</span><span class="line-counter cline-no">！</span><code><span>  if(m.length &gt; (k - 11)) </span><span class="cstat-no" title="statement not covered">{</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1562</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var error = new Error(&#39;Message is too long for PKCS#1 v1.5 padding.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1563</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.length = m.length;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1564</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    error.max = k - 11;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1565</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw error;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1566</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1567</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1568</span><span class="line-counter cline-yes">&nbsp</span><code>  /* A block type BT, a padding string PS, and the data D shall be</code></div>
<div class="source-line"><span class="line-number ">1569</span><span class="line-counter cline-yes">&nbsp</span><code>    formatted into an octet string EB, the encryption block:</code></div>
<div class="source-line"><span class="line-number ">1570</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1571</span><span class="line-counter cline-yes">&nbsp</span><code>    EB = 00 || BT || PS || 00 || D</code></div>
<div class="source-line"><span class="line-number ">1572</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1573</span><span class="line-counter cline-yes">&nbsp</span><code>    The block type BT shall be a single octet indicating the structure of</code></div>
<div class="source-line"><span class="line-number ">1574</span><span class="line-counter cline-yes">&nbsp</span><code>    the encryption block. For this version of the document it shall have</code></div>
<div class="source-line"><span class="line-number ">1575</span><span class="line-counter cline-yes">&nbsp</span><code>    value 00, 01, or 02. For a private-key operation, the block type</code></div>
<div class="source-line"><span class="line-number ">1576</span><span class="line-counter cline-yes">&nbsp</span><code>    shall be 00 or 01. For a public-key operation, it shall be 02.</code></div>
<div class="source-line"><span class="line-number ">1577</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1578</span><span class="line-counter cline-yes">&nbsp</span><code>    The padding string PS shall consist of k-3-||D|| octets. For block</code></div>
<div class="source-line"><span class="line-number ">1579</span><span class="line-counter cline-yes">&nbsp</span><code>    type 00, the octets shall have value 00; for block type 01, they</code></div>
<div class="source-line"><span class="line-number ">1580</span><span class="line-counter cline-yes">&nbsp</span><code>    shall have value FF; and for block type 02, they shall be</code></div>
<div class="source-line"><span class="line-number ">1581</span><span class="line-counter cline-yes">&nbsp</span><code>    pseudorandomly generated and nonzero. This makes the length of the</code></div>
<div class="source-line"><span class="line-number ">1582</span><span class="line-counter cline-yes">&nbsp</span><code>    encryption block EB equal to k. */</code></div>
<div class="source-line"><span class="line-number ">1583</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1584</span><span class="line-counter cline-yes">&nbsp</span><code>  // build the encryption block</code></div>
<div class="source-line"><span class="line-number ">1585</span><span class="line-counter cline-yes">&nbsp</span><code>  eb.putByte(0x00);</code></div>
<div class="source-line"><span class="line-number ">1586</span><span class="line-counter cline-yes">&nbsp</span><code>  eb.putByte(bt);</code></div>
<div class="source-line"><span class="line-number ">1587</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1588</span><span class="line-counter cline-yes">&nbsp</span><code>  // create the padding</code></div>
<div class="source-line"><span class="line-number ">1589</span><span class="line-counter cline-yes">&nbsp</span><code>  var padNum = k - 3 - m.length;</code></div>
<div class="source-line"><span class="line-number ">1590</span><span class="line-counter cline-yes">&nbsp</span><code>  var padByte;</code></div>
<div class="source-line"><span class="line-number ">1591</span><span class="line-counter cline-yes">&nbsp</span><code>  // private key op</code></div>
<div class="source-line"><span class="line-number ">1592</span><span class="line-counter cline-yes">&nbsp</span><code>  if(bt === 0x00 || bt === 0x01) {</code></div>
<div class="source-line"><span class="line-number ">1593</span><span class="line-counter cline-no">！</span><code><span>    padByte = (bt === 0x00) </span><span class="cstat-no" title="statement not covered">? 0x00</span><span> : 0xFF;</span></code></div>
<div class="source-line"><span class="line-number ">1594</span><span class="line-counter cline-yes">&nbsp</span><code>    for(var i = 0; i &lt; padNum; ++i) {</code></div>
<div class="source-line"><span class="line-number ">1595</span><span class="line-counter cline-yes">&nbsp</span><code>      eb.putByte(padByte);</code></div>
<div class="source-line"><span class="line-number ">1596</span><span class="line-counter cline-yes">&nbsp</span><code>    }</code></div>
<div class="source-line"><span class="line-number ">1597</span><span class="line-counter cline-no">！</span><code><span>  }</span><span class="cstat-no" title="statement not covered"> else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1598</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // public key op</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1599</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // pad with random non-zero values</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1600</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    while(padNum &gt; 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1601</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var numZeros = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1602</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var padBytes = forge.random.getBytes(padNum);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1603</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      for(var i = 0; i &lt; padNum; ++i) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1604</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        padByte = padBytes.charCodeAt(i);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1605</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        if(padByte === 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1606</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          ++numZeros;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1607</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        } else {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1608</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">          eb.putByte(padByte);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1609</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1610</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1611</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      padNum = numZeros;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1612</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1613</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1614</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1615</span><span class="line-counter cline-yes">&nbsp</span><code>  // zero followed by message</code></div>
<div class="source-line"><span class="line-number ">1616</span><span class="line-counter cline-yes">&nbsp</span><code>  eb.putByte(0x00);</code></div>
<div class="source-line"><span class="line-number ">1617</span><span class="line-counter cline-yes">&nbsp</span><code>  eb.putBytes(m);</code></div>
<div class="source-line"><span class="line-number ">1618</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1619</span><span class="line-counter cline-yes">&nbsp</span><code>  return eb;</code></div>
<div class="source-line"><span class="line-number ">1620</span><span class="line-counter cline-yes">&nbsp</span><code>}</code></div>
<div class="source-line"><span class="line-number ">1621</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1622</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1623</span><span class="line-counter cline-yes">&nbsp</span><code> * Decodes a message using PKCS#1 v1.5 padding.</code></div>
<div class="source-line"><span class="line-number ">1624</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1625</span><span class="line-counter cline-yes">&nbsp</span><code> * @param em the message to decode.</code></div>
<div class="source-line"><span class="line-number ">1626</span><span class="line-counter cline-yes">&nbsp</span><code> * @param key the RSA key to use.</code></div>
<div class="source-line"><span class="line-number ">1627</span><span class="line-counter cline-yes">&nbsp</span><code> * @param pub true if the key is a public key, false if it is private.</code></div>
<div class="source-line"><span class="line-number ">1628</span><span class="line-counter cline-yes">&nbsp</span><code> * @param ml the message length, if specified.</code></div>
<div class="source-line"><span class="line-number ">1629</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1630</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the decoded bytes.</code></div>
<div class="source-line"><span class="line-number ">1631</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1632</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _decodePkcs1_v1_5(em, key, pub, ml) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1633</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // get the length of the modulus in bytes</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1634</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var k = Math.ceil(key.n.bitLength() / 8);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1635</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1636</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  /* It is an error if any of the following conditions occurs:</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1637</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1638</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    1. The encryption block EB cannot be parsed unambiguously.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1639</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    2. The padding string PS consists of fewer than eight octets</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1640</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      or is inconsisent with the block type BT.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1641</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    3. The decryption process is a public-key operation and the block</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1642</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      type BT is not 00 or 01, or the decryption process is a</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1643</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      private-key operation and the block type is not 02.</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1644</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">   */</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1645</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1646</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // parse the encryption block</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1647</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var eb = forge.util.createBuffer(em);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1648</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var first = eb.getByte();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1649</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var bt = eb.getByte();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1650</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(first !== 0x00 ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1651</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (pub &amp;&amp; bt !== 0x00 &amp;&amp; bt !== 0x01) ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1652</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (!pub &amp;&amp; bt != 0x02) ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1653</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (pub &amp;&amp; bt === 0x00 &amp;&amp; typeof(ml) === &#39;undefined&#39;)) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1654</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(&#39;Encryption block is invalid.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1655</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1656</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1657</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var padNum = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1658</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bt === 0x00) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1659</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // check all padding bytes for 0x00</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1660</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    padNum = k - 3 - ml;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1661</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    for(var i = 0; i &lt; padNum; ++i) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1662</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(eb.getByte() !== 0x00) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1663</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        throw new Error(&#39;Encryption block is invalid.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1664</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1665</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1666</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  } else if(bt === 0x01) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1667</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // find the first byte that isn&#39;t 0xFF, should be after all padding</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1668</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    padNum = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1669</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    while(eb.length() &gt; 1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1670</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(eb.getByte() !== 0xFF) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1671</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        --eb.read;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1672</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        break;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1673</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1674</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      ++padNum;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1675</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1676</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  } else if(bt === 0x02) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1677</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // look for 0x00 byte</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1678</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    padNum = 0;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1679</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    while(eb.length() &gt; 1) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1680</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(eb.getByte() === 0x00) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1681</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        --eb.read;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1682</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        break;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1683</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1684</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      ++padNum;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1685</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1686</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1687</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1688</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // zero must be 0x00 and padNum must be (k - 3 - message length)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1689</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var zero = eb.getByte();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1690</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(zero !== 0x00 || padNum !== (k - 3 - eb.length())) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1691</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(&#39;Encryption block is invalid.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1692</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1693</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1694</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return eb.getBytes();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1695</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1696</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1697</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1698</span><span class="line-counter cline-yes">&nbsp</span><code> * Runs the key-generation algorithm asynchronously, either in the background</code></div>
<div class="source-line"><span class="line-number ">1699</span><span class="line-counter cline-yes">&nbsp</span><code> * via Web Workers, or using the main thread and setImmediate.</code></div>
<div class="source-line"><span class="line-number ">1700</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1701</span><span class="line-counter cline-yes">&nbsp</span><code> * @param state the key-pair generation state.</code></div>
<div class="source-line"><span class="line-number ">1702</span><span class="line-counter cline-yes">&nbsp</span><code> * @param [options] options for key-pair generation:</code></div>
<div class="source-line"><span class="line-number ">1703</span><span class="line-counter cline-yes">&nbsp</span><code> *          workerScript the worker script URL.</code></div>
<div class="source-line"><span class="line-number ">1704</span><span class="line-counter cline-yes">&nbsp</span><code> *          workers the number of web workers (if supported) to use,</code></div>
<div class="source-line"><span class="line-number ">1705</span><span class="line-counter cline-yes">&nbsp</span><code> *            (default: 2, -1 to use estimated cores minus one).</code></div>
<div class="source-line"><span class="line-number ">1706</span><span class="line-counter cline-yes">&nbsp</span><code> *          workLoad the size of the work load, ie: number of possible prime</code></div>
<div class="source-line"><span class="line-number ">1707</span><span class="line-counter cline-yes">&nbsp</span><code> *            numbers for each web worker to check per work assignment,</code></div>
<div class="source-line"><span class="line-number ">1708</span><span class="line-counter cline-yes">&nbsp</span><code> *            (default: 100).</code></div>
<div class="source-line"><span class="line-number ">1709</span><span class="line-counter cline-yes">&nbsp</span><code> * @param callback(err, keypair) called once the operation completes.</code></div>
<div class="source-line"><span class="line-number ">1710</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1711</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _generateKeyPair(state, options, callback) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1712</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(typeof options === &#39;function&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1713</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    callback = options;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1714</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    options = {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1715</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1716</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  options = options || {};</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1717</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1718</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var opts = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1719</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    algorithm: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1720</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      name: options.algorithm || &#39;PRIMEINC&#39;,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1721</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      options: {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1722</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        workers: options.workers || 2,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1723</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        workLoad: options.workLoad || 100,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1724</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        workerScript: options.workerScript</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1725</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1726</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1727</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1728</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(&#39;prng&#39; in options) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1729</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    opts.prng = options.prng;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1730</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1731</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1732</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  generate();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1733</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1734</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  function generate() {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1735</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // find p and then q (done in series to simplify)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1736</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    getPrime(state.pBits, function(err, num) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1737</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1738</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1739</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1740</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.p = num;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1741</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      if(state.q !== null) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1742</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        return finish(err, state.q);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1743</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1744</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      getPrime(state.qBits, finish);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1745</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    });</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1746</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1747</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1748</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  function getPrime(bits, callback) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1749</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    forge.prime.generateProbablePrime(bits, opts, callback);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1750</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1751</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1752</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  function finish(err, num) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1753</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(err) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1754</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      return callback(err);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1755</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1756</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1757</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // set q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1758</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.q = num;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1759</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1760</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // ensure p is larger than q (swap them if not)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1761</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.p.compareTo(state.q) &lt; 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1762</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      var tmp = state.p;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1763</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.p = state.q;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1764</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.q = tmp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1765</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1766</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1767</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // ensure p is coprime with e</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1768</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.p.subtract(BigInteger.ONE).gcd(state.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1769</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      .compareTo(BigInteger.ONE) !== 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1770</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.p = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1771</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      generate();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1772</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      return;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1773</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1774</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1775</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // ensure q is coprime with e</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1776</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.q.subtract(BigInteger.ONE).gcd(state.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1777</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      .compareTo(BigInteger.ONE) !== 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1778</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.q = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1779</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      getPrime(state.qBits, finish);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1780</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      return;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1781</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1782</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1783</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // compute phi: (p - 1)(q - 1) (Euler&#39;s totient function)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1784</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.p1 = state.p.subtract(BigInteger.ONE);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1785</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.q1 = state.q.subtract(BigInteger.ONE);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1786</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.phi = state.p1.multiply(state.q1);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1787</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1788</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // ensure e and phi are coprime</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1789</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.phi.gcd(state.e).compareTo(BigInteger.ONE) !== 0) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1790</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // phi and e aren&#39;t coprime, so generate a new p and q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1791</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.p = state.q = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1792</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      generate();</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1793</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      return;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1794</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1795</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1796</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // create n, ensure n is has the right number of bits</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1797</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.n = state.p.multiply(state.q);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1798</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    if(state.n.bitLength() !== state.bits) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1799</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      // failed, get new q</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1800</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      state.q = null;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1801</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      getPrime(state.qBits, finish);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1802</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      return;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1803</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1804</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1805</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // set keys</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1806</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    var d = state.e.modInverse(state.phi);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1807</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    state.keys = {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1808</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      privateKey: pki.rsa.setPrivateKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1809</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.n, state.e, d, state.p, state.q,</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1810</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        d.mod(state.p1), d.mod(state.q1),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1811</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">        state.q.modInverse(state.p)),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1812</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      publicKey: pki.rsa.setPublicKey(state.n, state.e)</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1813</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    };</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1814</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1815</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    callback(null, state.keys);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1816</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1817</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1818</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1819</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1820</span><span class="line-counter cline-yes">&nbsp</span><code> * Converts a positive BigInteger into 2&#39;s-complement big-endian bytes.</code></div>
<div class="source-line"><span class="line-number ">1821</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1822</span><span class="line-counter cline-yes">&nbsp</span><code> * @param b the big integer to convert.</code></div>
<div class="source-line"><span class="line-number ">1823</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1824</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the bytes.</code></div>
<div class="source-line"><span class="line-number ">1825</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1826</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _bnToBytes(b) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1827</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // prepend 0x00 if first byte &gt;= 0x80</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1828</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var hex = b.toString(16);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1829</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(hex[0] &gt;= &#39;8&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1830</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    hex = &#39;00&#39; + hex;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1831</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1832</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var bytes = forge.util.hexToBytes(hex);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1833</span><span class="line-counter cline-no">！</span><code><span class="cstat-no" title="statement not covered"><br/></span><span></span></code></div>
<div class="source-line"><span class="line-number ">1834</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  // ensure integer is minimally-encoded</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1835</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bytes.length &gt; 1 &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1836</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // leading 0x00 for positive integer</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1837</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    ((bytes.charCodeAt(0) === 0 &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1838</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (bytes.charCodeAt(1) &amp; 0x80) === 0) ||</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1839</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    // leading 0xFF for negative integer</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1840</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (bytes.charCodeAt(0) === 0xFF &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1841</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    (bytes.charCodeAt(1) &amp; 0x80) === 0x80))) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1842</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    return bytes.substr(1);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1843</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1844</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return bytes;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1845</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1846</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1847</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1848</span><span class="line-counter cline-yes">&nbsp</span><code> * Returns the required number of Miller-Rabin tests to generate a</code></div>
<div class="source-line"><span class="line-number ">1849</span><span class="line-counter cline-yes">&nbsp</span><code> * prime with an error probability of (1/2)^80.</code></div>
<div class="source-line"><span class="line-number ">1850</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1851</span><span class="line-counter cline-yes">&nbsp</span><code> * See Handbook of Applied Cryptography Chapter 4, Table 4.4.</code></div>
<div class="source-line"><span class="line-number ">1852</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1853</span><span class="line-counter cline-yes">&nbsp</span><code> * @param bits the bit size.</code></div>
<div class="source-line"><span class="line-number ">1854</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1855</span><span class="line-counter cline-yes">&nbsp</span><code> * @return the required number of iterations.</code></div>
<div class="source-line"><span class="line-number ">1856</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1857</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _getMillerRabinTests(bits) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1858</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 100) return 27;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1859</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 150) return 18;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1860</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 200) return 15;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1861</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 250) return 12;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1862</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 300) return 9;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1863</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 350) return 8;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1864</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 400) return 7;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1865</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 500) return 6;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1866</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 600) return 5;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1867</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 800) return 4;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1868</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(bits &lt;= 1250) return 3;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1869</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return 2;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1870</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1871</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1872</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1873</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs feature detection on the Node crypto interface.</code></div>
<div class="source-line"><span class="line-number ">1874</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1875</span><span class="line-counter cline-yes">&nbsp</span><code> * @param fn the feature (function) to detect.</code></div>
<div class="source-line"><span class="line-number ">1876</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1877</span><span class="line-counter cline-yes">&nbsp</span><code> * @return true if detected, false if not.</code></div>
<div class="source-line"><span class="line-number ">1878</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1879</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _detectNodeCrypto(fn) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1880</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return forge.util.isNodejs &amp;&amp; typeof _crypto[fn] === &#39;function&#39;;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1881</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1882</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1883</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1884</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs feature detection on the SubtleCrypto interface.</code></div>
<div class="source-line"><span class="line-number ">1885</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1886</span><span class="line-counter cline-yes">&nbsp</span><code> * @param fn the feature (function) to detect.</code></div>
<div class="source-line"><span class="line-number ">1887</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1888</span><span class="line-counter cline-yes">&nbsp</span><code> * @return true if detected, false if not.</code></div>
<div class="source-line"><span class="line-number ">1889</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1890</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _detectSubtleCrypto(fn) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1891</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return (typeof util.globalScope !== &#39;undefined&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1892</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.crypto === &#39;object&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1893</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.crypto.subtle === &#39;object&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1894</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.crypto.subtle[fn] === &#39;function&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1895</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1896</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1897</span><span class="line-counter cline-yes">&nbsp</span><code>/**</code></div>
<div class="source-line"><span class="line-number ">1898</span><span class="line-counter cline-yes">&nbsp</span><code> * Performs feature detection on the deprecated Microsoft Internet Explorer</code></div>
<div class="source-line"><span class="line-number ">1899</span><span class="line-counter cline-yes">&nbsp</span><code> * outdated SubtleCrypto interface. This function should only be used after</code></div>
<div class="source-line"><span class="line-number ">1900</span><span class="line-counter cline-yes">&nbsp</span><code> * checking for the modern, standard SubtleCrypto interface.</code></div>
<div class="source-line"><span class="line-number ">1901</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1902</span><span class="line-counter cline-yes">&nbsp</span><code> * @param fn the feature (function) to detect.</code></div>
<div class="source-line"><span class="line-number ">1903</span><span class="line-counter cline-yes">&nbsp</span><code> *</code></div>
<div class="source-line"><span class="line-number ">1904</span><span class="line-counter cline-yes">&nbsp</span><code> * @return true if detected, false if not.</code></div>
<div class="source-line"><span class="line-number ">1905</span><span class="line-counter cline-yes">&nbsp</span><code> */</code></div>
<div class="source-line"><span class="line-number ">1906</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _detectSubtleMsCrypto(fn) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1907</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return (typeof util.globalScope !== &#39;undefined&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1908</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.msCrypto === &#39;object&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1909</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.msCrypto.subtle === &#39;object&#39; &amp;&amp;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1910</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    typeof util.globalScope.msCrypto.subtle[fn] === &#39;function&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1911</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1912</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1913</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _intToUint8Array(x) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1914</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var bytes = forge.util.hexToBytes(x.toString(16));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1915</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  var buffer = new Uint8Array(bytes.length);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1916</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  for(var i = 0; i &lt; bytes.length; ++i) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1917</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    buffer[i] = bytes.charCodeAt(i);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1918</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1919</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return buffer;</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1920</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1921</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1922</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _privateKeyFromJwk(jwk) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1923</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(jwk.kty !== &#39;RSA&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1924</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1925</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">      &#39;Unsupported key algorithm &quot;&#39; + jwk.kty + &#39;&quot;; algorithm must be &quot;RSA&quot;.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1926</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1927</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return pki.setRsaPrivateKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1928</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.n),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1929</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.e),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1930</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.d),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1931</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.p),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1932</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.q),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1933</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.dp),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1934</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.dq),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1935</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.qi));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1936</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1937</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1938</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _publicKeyFromJwk(jwk) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1939</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  if(jwk.kty !== &#39;RSA&#39;) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1940</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    throw new Error(&#39;Key algorithm must be &quot;RSA&quot;.&#39;);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1941</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  }</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1942</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return pki.setRsaPublicKey(</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1943</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.n),</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1944</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">    _base64ToBigInt(jwk.e));</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1945</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1946</span><span class="line-counter cline-yes">&nbsp</span><code></code></div>
<div class="source-line"><span class="line-number ">1947</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">function _base64ToBigInt(b64) {</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1948</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">  return new BigInteger(forge.util.bytesToHex(forge.util.decode64(b64)), 16);</span><span></span></code></div>
<div class="source-line"><span class="line-number ">1949</span><span class="line-counter cline-no">！</span><code><span></span><span class="cstat-no" title="statement not covered">}</span><span></span></code></div>

    </div>
    <script>

        const ISSUE_TYPE_CLASSES_OR_NAME = {
			'severity-critical': 'issue-critical',
			'severity-major': 'issue-major',
			'severity-minor': 'issue-minor',
			'issue-type-memory-access': 'issue-memory-access',
			'issue-type-branch': 'issue-branch',
		};
            ISSUE_TYPE_CLASSES_OR_NAME['target-RSASIGN'] = 'target-RSASIGN';

		const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const buttons = document.querySelectorAll('input[type="button"]');

		function change() {
            var elem = document.getElementById('button1');
            const fold = ' Fold leak details ';
            const deploy = ' Deploy leak details ';
            if (elem.innerHTML === deploy) {
                elem.innerHTML = fold;
            } else if (elem.innerHTML === fold) {
                elem.innerHTML = deploy;
            } else {
                console.log(elem.innerHTML);
            }

            const issueSummaries = document.querySelectorAll('details.issue-inline-message' + ' summary');
            const issueSummariesOpen = document.querySelectorAll('details.issue-inline-message[open]' + ' summary');
            const issueSummariesArray = Array.from(issueSummaries);
            const issueSummariesOpenArray = Array.from(issueSummariesOpen);

            if (elem.innerHTML === fold) {
                let issueSummariesClose = [];
                for (let i = 0; i < issueSummariesArray.length; i++) {
                    const issue = issueSummariesArray[i];
                    if (!(issueSummariesOpenArray.includes(issue))) {
                        issueSummariesClose.push(issue);
                    }
                }
                for (let k = 0; k < issueSummariesClose.length; k++) {
		            issueSummariesClose[k].click();
		            for (let i = 0; i < 5 ; i++) {
		                checkboxes[i].checked = true;
            	    }
            	}
            } else if (elem.innerHTML === deploy) {
                for (let k = 0; k < issueSummariesOpen.length; k++) {
	                issueSummariesOpenArray[k].click()
	                for (let i = 0; i < 5 ; i++) { // 5 first checkboxes are Severity and Issue type one, others are for target-name
		                checkboxes[i].checked = false;
            	   }
                }
            } else {
                console.log("error");
            }
        }

        change();

        var lastClick = ["0"];
		for (let i = 0; i < checkboxes.length; i++) {
		    checkboxes[i].addEventListener('change', () => {
// 		        console.log(ISSUE_TYPE_CLASSES_OR_NAME[checkboxes[i].name]);
		        const issueSelector = '.' + ISSUE_TYPE_CLASSES_OR_NAME[checkboxes[i].name];
		        const issueSummaries = document.querySelectorAll('details' + issueSelector + ' > summary');
		        for (let i = 0; i < issueSummaries.length; i++) {
			        issueSummaries[i].click();
			    }
	        });
	   }
       
    </script>
  </body>
</html>